---
  - name: Include Database
    include: tasks/audit_oraclelinux7.yml
    become: yes

  - name: Include Database
    include: tasks/actualfact_oraclelinux7.yml
    become: yes

  - name: Include Database
    include: tasks/before_linux.yml
    become: yes

  - name: registering the values column from db
    shell: "{{ db_type }} -u {{ db_user }} -p{{ db_passwd }} -h {{ db_host }} {{ db }} -e \"select before_actual from cis_remedy where id = {{ remedy_id }}\""
    register: database
    delegate_to: localhost
    become: yes
    tags:
      - always
      
  - name: Rollback cramfs
    lineinfile:
      path: /etc/modprobe.d/cramfs.conf
      line: "install cramfs /bin/true"
      state: absent
    when: ((database.stdout_lines[1]|from_json).cramfs_1111_actual.cramfs_1111_actual | regex_search('(install)')) != "install"
    become: yes
    tags:
      - cramfs
      - 1.1.1.1
      - one
      - all
      - rollback

  - name: Rollback squashfs
    lineinfile:
      path: /etc/modprobe.d/squashfs.conf
      line: "install squashfs /bin/true # Disable suqashfs filesystems"
      state: absent
    when: ((database.stdout_lines[1]|from_json).squashfs_1112_actual.squashfs_1112_actual | regex_search('(install squashfs)')) != "install squashfs"
    become: yes
    tags:
      - squashfs
      - 1.1.1.2
      - one
      - all
      - rollback
 
  - name: Rollback udf
    lineinfile:
      path: /etc/modprobe.d/udf.conf
      line: "install udf /bin/true # Disable udf Filesystems"
      state: absent
    when: ((database.stdout_lines[1]|from_json).udf_1113_actual.udf_1113_actual | regex_search('(install)')) != "install"
    become: yes
    tags:
      - udf
      - 1.1.1.3
      - one
      - all
      - rollback

  - name: Rollback fat
    lineinfile:
      path: /etc/modprobe.d/fat.conf
      line: "{{item}}"
      state: absent
    with_items:
      - "install fat /bin/true"
      - "install vfat /bin/true"
      - "install msdos /bin/true"
    when: ((database.stdout_lines[1]|from_json).fat_1114_actual.fat_1114_actual | regex_search('(fat)')) != "fat" and ((database.stdout_lines[1]|from_json).fat_1114_actual.fat_1114_actual | regex_search('(vfat)')) != "vfat" and ((database.stdout_lines[1]|from_json).fat_1114_actual.fat_1114_actual | regex_search('(msdos)')) != "msdos"
    become: yes
    tags:
      - fat
      - 1.1.1.4
      - one
      - all
      - rollback

  - name: Rollback tmp
    lineinfile:
      path: /etc/fstab
      line: tmpfs  /tmp  tmpfs   defaults,rw,nosuid,nodev,noexec,relatime 0 0
      state: absent
    when: ((database.stdout_lines[1]|from_json).tmp_112_actual.tmp_112_actual | regex_search('(/tmp)')) != "/tmp"
    become: yes
    tags:
      - tmp
      - 1.1.2
      - one
      - all
      - rollback

  - name: Rollback tmp
    mount:
      path: /tmp
      src: /etc
      opts: noexec,nodev,nosuid
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).tmp_112_actual.tmp_112_actual | regex_search('(/tmp)')) != "/tmp"
    become: yes
    tags:
      - tmp
      - 1.1.2
      - one
      - all
      - rollback
      
  - name: Rollback tmpnoexec
    mount:
      path: /tmp
      src: /etc
      opts: noexec
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).tmpnoexec_113_actual.tmpnoexec_113_actual | regex_search('(noexec)')) != "noexec"
    become: yes
    tags:
      - tmpnoexec
      - 1.1.3
      - one
      - all
      - rollback

  - name: Rollback tmpnodev
    mount:
      path: /tmp
      src: /etc
      opts: nodev
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).tmpnodev_114_actual.tmpnodev_114_actual | regex_search('(nodev)')) != "nodev"
    become: yes
    tags:
      - tmpnodev
      - 1.1.4
      - one
      - all
      - rollback

  - name: Rollback tmpnosuid
    mount:
      path: /tmp
      src: /etc
      opts: nosuid
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).tmpnosuid_115_actual.tmpnosuid_115_actual | regex_search('(nosuid)')) != "nosuid"
    become: yes
    tags:
      - tmpnosuid
      - 1.1.5
      - one
      - all
      - rollback

  - name: Rollback shmnconfig
    lineinfile:
      path: /etc/fstab
      line: tmpfs  /dev/shm  tmpfs   defaults,noexec,nodev,nosuid,seclabel  0 0
      state: absent
    when: ((database.stdout_lines[1]|from_json).shmnconfig_116_actual.shmnconfig_116_actual | regex_search('(/dev/shm)')) != "/dev/shm"
    become: yes
    tags:
      - shmnconfig
      - 1.1.6
      - one
      - all
      - rollback

  - name: Rollback shmnconfig
    mount:
      path: /dev/shm
      src: /etc
      opts: noexec,nodev,nosuid
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).shmnconfig_116_actual.shmnconfig_116_actual | regex_search('(/dev/shm)')) != "/dev/shm"
    become: yes
    tags:
      - shmnconfig
      - 1.1.6
      - one
      - all    
      - rollback

  - name: Rollback shmnoexec
    mount:
      path: /dev/tmp
      src: /etc
      opts: noexec
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).shmnoexec_117_actual.shmnoexec_117_actual | regex_search('(noexec)')) != "noexec"
    become: yes
    tags:
      - shmnoexec
      - 1.1.7
      - one
      - all
      - rollback

  - name: Rollback shmnodev
    mount:
      path: /dev/tmp
      src: /etc
      opts: nodev
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).shmnodev_118_actual.shmnodev_118_actual | regex_search('(nodev)')) != "nodev"
    become: yes
    tags:
      - shmnodev
      - 1.1.8
      - one
      - all
      - rollback

  - name: Rollback shmnosuid
    mount:
      path: /dev/tmp
      src: /etc
      opts: nosuid
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).shmnosuid_119_actual.shmnosuid_119_actual | regex_search('(nosuid)')) != "nosuid"
    become: yes
    tags:
      - shmnosuid
      - 1.1.9
      - one
      - all
      - rollback

  - name: Rollback vtnoexec
    mount:
      path: /var/tmp
      src: /etc
      opts: noexec
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).vtnoexec_1112_actual.vtnoexec_1112_actual | regex_search('(noexec)')) != "noexec"
    become: yes
    tags:
      - vtnoexec
      - 1.1.12
      - one
      - all
      - rollback

  - name: Rollback vtnodev
    mount:
      path: /var/tmp
      src: /etc
      opts: nodev
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).vtnodev_1113_actual.vtnodev_1113_actual | regex_search('(nodev)')) != "nodev"
    become: yes
    tags:
      - vtnodev
      - 1.1.13
      - one
      - all
      - rollback

  - name: Rollback vtnosuid
    mount:
      path: /var/tmp
      src: /etc
      opts: nosuid
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).vtnosuid_1114_actual.vtnosuid_1114_actual | regex_search('(nosuid)')) != "nosuid"
    become: yes
    tags:
      - vtnosuid
      - 1.1.14
      - one
      - all      
      - rollback
      
  - name: Rollback homenodev
    mount:
      path: /home
      opts: nodev
      fstype: none
      state: unmounted
    when: ((database.stdout_lines[1]|from_json).homenodev_1118_actual.homenodev_1118_actual | regex_search('(nodev)')) != "nodev"
    become: yes
    tags:
      - homenodev
      - 1.1.18
      - one
      - all
      - rollback

  - name: Rollback medianoexec
    shell: |
       for a in $(mount -l -t vfat,iso9660,ext | awk '{print $1}'); do
            b=$(grep -nr $a /etc/fstab | sed 's/^\([0-9]\+\):.*$/\1/')
            sed -i "$b s/,noexec//g" /etc/fstab
       done
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).medianoexec_1119_actual.medianoexec_1119_actual | regex_search('(noexec)')) != "noexec" and ((database.stdout_lines[1]|from_json).medianoexec_1119_actual.medianoexec_1119_actual | regex_search('(no removable partition)')) != "no removable partition"
    become: yes	
    tags:
      - medianoexec
      - 1.1.19
      - one
      - rollback
      - all
	  
  - name: Rollback medianodev
    shell: |
       for a in $(mount -l -t vfat,iso9660,ext | awk '{print $1}'); do
            b=$(grep -nr $a /etc/fstab | sed 's/^\([0-9]\+\):.*$/\1/')
            sed -i "$b s/,nodev//g" /etc/fstab
       done
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).medianodev_1120_actual.medianodev_1120_actual | regex_search('(nodev)')) != "nodev" and ((database.stdout_lines[1]|from_json).medianodev_1120_actual.medianodev_1120_actual | regex_search('(no removable partition)')) != "no removable partition"
    become: yes	
    tags:
      - medianodev
      - 1.1.20
      - one
      - rollback
      - all

  - name: Rollback medianosuid
    shell: |
       for a in $(mount -l -t vfat,iso9660,ext | awk '{print $1}'); do
            b=$(grep -nr $a /etc/fstab | sed 's/^\([0-9]\+\):.*$/\1/')
            sed -i "$b s/,nosuid//g" /etc/fstab
       done
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).medianosuid_1121_actual.medianosuid_1121_actual | regex_search('(nosuid)')) != "nosuid" and ((database.stdout_lines[1]|from_json).medianosuid_1121_actual.medianosuid_1121_actual | regex_search('(no removable partition)')) != "no removable partition"
    become: yes
    tags:
      - medianosuid
      - 1.1.21
      - one
      - rollback	  
      - all

  - name: Rollback stickybit
    shell: df --local -P | awk {'if (NR!=1) print $6'} | xargs -I '{}' find '{}' -xdev -type d -perm -0002 2>/dev/null | xargs chmod a-t
    when: ((database.stdout_lines[1]|from_json).stickybit_1122_actual.stickybit_1122_actual | regex_search('(Sticky bit)')) != "Sticky bit"
    become: yes
    tags:
      - stickybit
      - 1.1.22
      - one
      - all
      - rollback
      
  - name: Rollback automount
    systemd:
      name: autofs
      masked: no
    when: ((database.stdout_lines[1]|from_json).automount_1123_actual.automount_1123_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - automount
      - 1.1.23
      - one
      - all
      - rollback

  - name: Rollback usbstorage
    lineinfile:
      path: /etc/modprobe.d/usb_storage.conf
      line: "install usb-storage /bin/true"
      state: absent
    when: ((database.stdout_lines[1]|from_json).usbstorage_1124_actual.usbstorage_1124_actual | regex_search('(install)')) != "install"
    become: yes
    tags:
      - usbstorage
      - 1.1.24
      - one
      - all
      - rollback

  - name: Rollback gpgcheck
    replace:
      path: /etc/yum.conf
      regexp: "^gpgcheck=1"
      replace: gpgcheck=0
    when: ((database.stdout_lines[1]|from_json).gpgcheck_123_actual.gpgcheck_123_actual | regex_search('(gpgcheck)')) != "gpgcheck"
    become: yes
    tags:
      - gpgcheck
      - 1.2.3
      - one
      - all
      - rollback

  - name: Rollback gpgcheck
    replace:
      path: "{{item}}"
      regexp: "^(gpgcheck=1)"
      replace: gpgcheck=0
    loop: "{{ ((database.stdout_lines[1]|from_json).gpgcheck_123_actual.gpgcheck_123_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).gpgcheck_123_actual.gpgcheck_123_actual | regex_search('(gpgcheck)')) != "gpgcheck"
    become: yes
    tags:
      - gpgcheck
      - 1.2.3
      - one
      - all
      - rollback

  - name: Rollback sudo
    yum:
      name: sudo
      state: absent
    when: ((database.stdout_lines[1]|from_json).sudo_131_actual.sudo_131_actual | regex_search('(sudo)')) != "sudo"
    become: yes
    tags:
      - sudo
      - 1.3.1
      - one
      - all  
      - rollback

  - name: Rollback sudopty
    lineinfile:
      path: /etc/sudoers
      line: Defaults use_pty
      state: absent
    when: ((database.stdout_lines[1]|from_json).sudopty_132_actual.sudopty_132_actual | regex_search('(Defaults use_pty)')) != "Defaults use_pty"
    become: yes
    tags:
      - sudopty
      - 1.3.2
      - one
      - all
      - rollback

  - name: Rollback sudologfiles
    lineinfile:
      path: /etc/sudoers
      regexp: '^Defaults logfile=*'
      state: absent
    when: ((database.stdout_lines[1]|from_json).sudologfiles_133_actual.sudologfiles_133_actual | regex_search('(Defaults logfile)')) != "Defaults logfile"
    become: yes
    tags:
      - sudologfiles
      - 1.3.3
      - one
      - all 
      - rollback

  - name: Rollback aide
    yum:
       name: aide
       state: absent
    when: ((database.stdout_lines[1]|from_json).aide_141_actual.aide_141_actual | regex_search('(aide-)')) != "aide-"
    become: yes
    tags:
       - aide
       - 1.4.1
       - one
       - all
       - rollback

  - name: Rollback aide
    file:
      path: /var/lib/aide/aide.db.gz
      state: absent
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).aide_141_actual.aide_141_actual | regex_search('(aide-)')) != "aide-"
    become: yes
    tags:
       - aide
       - 1.4.1
       - one
       - all      
      - rollback
      
  - name: Rollback fsintegrity
    cron:
      name: Run Aide integrity check weekly
      user: "root"
      minute: "0"
      hour: "5"
      day: "*"
      month: "*"
      weekday: "*"
      job: "/usr/sbin/aide --check"
      state: absent
    when: ((database.stdout_lines[1]|from_json).fsintegrity_142_actual.fsintegrity_142_actual | regex_search('(/usr/sbin/aide)')) != "/usr/sbin/aide"
    become: yes
    tags:
      - fsintegrity
      - 1.4.2
      - one
      - all
      - rollback
      
  - name: Rollback bootloadpass
    file:
      path: /boot/grub2/user.cfg
      state: absent
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).bootloadpass_151_actual.bootloadpass_151_actual | regex_search('(GRUB2_PASSWORD=)')) != "GRUB2_PASSWORD="
    become: yes
    tags:
      - bootloadpass
      - 1.5.1
      - one
      - all
      - rollback

  - name: Rollback bootloadpass
    command: grub2-mkconfig -o /boot/grub2/grub.cfg
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).bootloadpass_151_actual.bootloadpass_151_actual | regex_search('(GRUB2_PASSWORD=)')) != "GRUB2_PASSWORD="
    become: yes
    tags:
      - bootloadpass
      - 1.5.1
      - one
      - all
      - rollback
      
  - name: Rollback bootloadperm
    file:
      path: /boot/grub2/grub.cfg
      owner: root
      group: root
      mode: 0644
    when: ((database.stdout_lines[1]|from_json).bootloadperm_152_actual.bootloadperm_152_actual | regex_search('(grub.cfg)')) != "grub.cfg" and ((database.stdout_lines[1]|from_json).bootloadperm_152_actual.bootloadperm_152_actual | regex_search('(user.cfg)')) != "user.cfg"
    become: yes
    tags:
      - bootloadperm
      - 1.5.2
      - one
      - all
      - rollback

  - name: Rollback bootloadperm
    file:
      path: /boot/grub2/user.cfg
      owner: root
      group: root
      mode: 0644
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).bootloadperm_152_actual.bootloadperm_152_actual | regex_search('(grub.cfg)')) != "grub.cfg" and ((database.stdout_lines[1]|from_json).bootloadperm_152_actual.bootloadperm_152_actual | regex_search('(user.cfg)')) != "user.cfg"
    become: yes
    tags:
      - bootloadperm
      - 1.5.2
      - one
      - all    
      - rollback
      
  - name: Rollback singleusermode
    command: sed -i '/ExecStart=-\/bin\/sh -c /s/\/usr\/sbin\/sulogin//g' /usr/lib/systemd/system/emergency.service
    when: ((database.stdout_lines[1]|from_json).singleusermode_153_actual.singleusermode_153_actual | regex_search('(/usr/sbin/sulogin)')) != "/usr/sbin/sulogin"
    become: yes
    tags:
      - singleusermode
      - 1.5.3
      - one
      - all
      - rollback

  - name: Rollback singleusermode
    command: sed -i '/ExecStart=-\/bin\/sh -c /s/\/usr\/sbin\/sulogin//g' /usr/lib/systemd/system/rescue.service
    when: ((database.stdout_lines[1]|from_json).singleusermode_153_actual.singleusermode_153_actual | regex_search('(/usr/sbin/sulogin)')) != "/usr/sbin/sulogin"
    become: yes
    tags:
      - singleusermode
      - 1.5.3
      - one
      - all
      - rollback
    
  - name: Rollback coredumps
    lineinfile:
      path: /etc/security/limits.conf
      line: '* hard core 0'
      state: absent
    when: ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(hard core)')) != "hard core" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable=)')) != ",fs.suid_dumpable=" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable =)')) != ",fs.suid_dumpable ="
    become: yes
    tags:
      - coredumps
      - 1.6.1
      - one
      - all
      - rollback

  - name: Rollback coredumps
    lineinfile:
      path: /etc/sysctl.conf
      line: 'fs.suid_dumpable=0'
      state: absent
    when: ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(hard core)')) != "hard core" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable=)')) != ",fs.suid_dumpable=" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable =)')) != ",fs.suid_dumpable ="
    become: yes
    tags:
      - coredumps
      - 1.6.1
      - one
      - all
      - rollback
   
  - name: Rollback coredumps
    sysctl:
      name: fs.suid_dumpable
      value: 0
      state: absent
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
    when: ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(hard core)')) != "hard core" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable=)')) != ",fs.suid_dumpable=" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable =)')) != ",fs.suid_dumpable ="
    become: yes
    tags:
      - coredumps
      - 1.6.1
      - one
      - all
      - rollback

  - name: Rollback coredumps
    lineinfile:
      state: present
      path: /etc/systemd/coredump.conf
      regexp: "^(Storage*|#Storage*)"
      line: '#Storage=none'
    when: ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(hard core)')) != "hard core" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable=)')) != ",fs.suid_dumpable=" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable =)')) != ",fs.suid_dumpable ="
    become: yes
    tags:
      - coredumps
      - 1.6.1
      - one
      - all    
      - rollback
    
  - name: Rollback coredumps
    lineinfile:
      state: present
      path: /etc/systemd/coredump.conf
      regexp: "^(ProcessSizeMax*|#ProcessSizeMax*)"
      line: '#ProcessSizeMax=0'
    when: ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(hard core)')) != "hard core" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable=)')) != ",fs.suid_dumpable=" and ((database.stdout_lines[1]|from_json).coredumps_161_actual.coredumps_161_actual | regex_search('(,fs.suid_dumpable =)')) != ",fs.suid_dumpable ="
    become: yes
    tags:
      - coredumps
      - 1.6.1
      - one
      - all
      - rollback
 
  - name: Rollback aslr
    lineinfile:
      path: /etc/sysctl.conf
      line: kernel.randomize_va_space=2
      state: absent
    when: ((database.stdout_lines[1]|from_json).aslr_163_actual.aslr_163_actual | regex_search('(kernel.randomize_va_space)')) != "kernel.randomize_va_space"
    become: yes
    tags:
      - aslr
      - 1.6.3
      - one
      - all
      - rollback

  - name: Rollback aslr
    sysctl:
      name: kernel.randomize_va_space
      value: 2
      state: absent
      reload: yes
      sysctl_set: yes
      ignoreerrors: yes
    when: ((database.stdout_lines[1]|from_json).aslr_163_actual.aslr_163_actual | regex_search('(kernel.randomize_va_space)')) != "kernel.randomize_va_space"
    become: yes
    tags:
      - 1.6.3
      - aslr
      - one
      - all
      - rollback

  - name: Rollback prelink
    yum:
      name: prelink
      state: present
    when: ((database.stdout_lines[1]|from_json).prelink_164_actual.prelink_164_actual | regex_search('(prelink)')) != "prelink"
    become: yes
    tags:
      - prelink
      - 1.6.4
      - one
      - all
      - rollback
      
  - name: Rollback selinux
    yum:
      name: libselinux
      state: absent
    when: ((database.stdout_lines[1]|from_json).selinux_1711_actual.selinux_1711_actual | regex_search('(libselinux)')) != "libselinux"
    become: yes
    tags:
      - selinux
      - 1.7.1.1
      - one
      - all    
      - rollback
      
  - name: Rollback seldisable
    command: sed -i 's/GRUB_CMDLINE_LINUX="[^"]*/& selinux=0/' /etc/default/grub
    when: ((database.stdout_lines[1]|from_json).seldisable_1712_actual.seldisable_1712_actual | regex_search('(SELinux)')) != "SELinux"
    become: yes
    tags:
      - seldisable
      - 1.7.1.2
      - one
      - all
      - rollback

  - name: Rollback seldisable
    command: grub2-mkconfig -o /boot/grub2/grub.cfg
    when: ((database.stdout_lines[1]|from_json).seldisable_1712_actual.seldisable_1712_actual | regex_search('(SELinux)')) != "SELinux"
    become: yes
    tags:
      - seldisable
      - 1.7.1.2
      - one
      - all
      - rollback

  - name: Rollback selpolicy
    replace:
      path: /etc/selinux/config
      regexp: "^(SELINUXTYPE=targeted)"
      replace: "{{ ((database.stdout_lines[1]|from_json).selpolicy_1713_actual.selpolicy_1713_actual | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).selpolicy_1713_actual.selpolicy_1713_actual | regex_search('(targeted)')) != "targeted"
    become: yes
    tags:
      - selpolicy
      - 1.7.1.3
      - one
      - all
      - rollback

  - name: Rollback selenfperm
    replace:
      path: /etc/selinux/config
      regexp: '^(SELINUX=.*)'
      replace: "{{ ((database.stdout_lines[1]|from_json).selenfperm_1714_actual.selenfperm_1714_actual |  regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).selenfperm_1714_actual.selenfperm_1714_actual | regex_search('(failed )'))
    become: yes
    tags:
      - selenfperm
      - 1.7.1.4
      - one
      - all
      - rollback

  - name: Rollback selstate
    replace:
      path: /etc/selinux/config
      regexp: '^(SELINUX=enforcing)'
      replace: "{{ ((database.stdout_lines[1]|from_json).selstate_1715_actual.selstate_1715_actual | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).selstate_1715_actual.selstate_1715_actual | regex_search('(enforcing)')) != "enforcing"
    become: yes
    tags:
      - selstate
      - 1.7.1.5
      - one
      - all      
      - rollback
      
  - name: Rollback setroubleshoot
    yum:
      name: setroubleshoot
      state: present
    when: ((database.stdout_lines[1]|from_json).setroubleshoot_1717_actual.setroubleshoot_1717_actual | regex_search('(setroubleshoot)')) != "setroubleshoot"
    become: yes
    tags:
      - setroubleshoot
      - 1.7.1.7
      - one
      - all
      - rollback

  - name: Rollback mcs
    yum:
      name: mcstrans
      state: present
    when: ((database.stdout_lines[1]|from_json).mcs_1718_actual.mcs_1718_actual | regex_search('(mcstrans)')) != "mcstrans"
    become: yes
    tags:
      - mcs
      - 1.7.1.8
      - one
      - all    
      - rollback
      
  - name: Rollback msgday
    lineinfile:
      path: /etc/motd
      line: "Welcome to RedHat 7"
      state: absent
    when: ((database.stdout_lines[1]|from_json).msgday_1811_actual.msgday_1811_actual | regex_search('(Welcome)')) != "Welcome"
    become: yes
    tags:
      - msgday
      - 1.8.1.1
      - one
      - all    
      - rollback
      
  - name: Rollback locallogin
    lineinfile:
      path: /etc/issue
      line: "Authorized uses only. All activity may be monitored and reported"
      state: absent
    when: ((database.stdout_lines[1]|from_json).locallogin_1812_actual.locallogin_1812_actual | regex_search('(monitored and reported)')) != "monitored and reported"
    become: yes
    tags:
      - locallogin
      - 1.8.1.2
      - one
      - all    
      - rollback
      
  - name: Rollback remotelogin
    lineinfile:
      path: /etc/issue.net
      line: "Authorized uses only. All activity may be monitored and reported"
      state: absent
    when: ((database.stdout_lines[1]|from_json).remotelogin_1813_actual.remotelogin_1813_actual | regex_search('(monitored and reported)')) != "monitored and reported"
    become: yes
    tags:
      - remotelogin
      - 1.8.1.3
      - one
      - all
      - rollback
      
  - name: Rollback motdperm
    file:
      path: /etc/motd
      owner: root
      group: root
      mode: 0600
    when: ((database.stdout_lines[1]|from_json).motdperm_1814_actual.motdperm_1814_actual | regex_search('(/etc/motd)')) != "/etc/motd"
    become: yes
    tags:
      - motdperm
      - 1.8.1.4
      - one
      - all
      - rollback
    
  - name: Rollback issueperm
    file:
      path: /etc/issue
      owner: root
      group: root
      mode: 0600
    when: ((database.stdout_lines[1]|from_json).issueperm_1815_actual.issueperm_1815_actual | regex_search('(/etc/issue)')) != "/etc/issue"
    become: yes
    tags:
      - issueperm
      - 1.8.1.5
      - one
      - all    
      - rollback
      
  - name: Rollback issuenetperm
    file:
      path: /etc/issue.net
      owner: root
      group: root
      mode: 0600
    when: ((database.stdout_lines[1]|from_json).issuenetperm_1816_actual.issuenetperm_1816_actual | regex_search('(/etc/issue.net)')) != "/etc/issue.net"
    become: yes
    tags:
      - issuenetperm
      - 1.8.1.6
      - one
      - all    
      - rollback
      
  - name: Rollback gdm
    replace:
      path: "{{ item.path }}"
      regexp: "{{ item.regexp }}"
      replace: '#\1'
    with_items:
      - { path: '/etc/dconf/profile/gdm', regexp: '^(user-db:user)' }
      - { path: '/etc/dconf/profile/gdm', regexp: '^(system-db:gdm)' }
      - { path: '/etc/dconf/profile/gdm', regexp: '^(file-db:/usr/share/gdm/greeter-dconf-defaults)' }
      - { path: '/etc/dconf/db/gdm.d/01-banner-message', regexp: '^(.*org/gnome/login-screen)' }
      - { path: '/etc/dconf/db/gdm.d/01-banner-message', regexp: '^(banner-message-enable=true)' }
      - { path: '/etc/dconf/db/gdm.d/01-banner-message', regexp: "^(banner-message-text='Authorized uses only. All activity may be monitored and reported.')" }
      - { path: '/etc/dconf/db/gdm.d/00-login-screen', regexp: "^(.*org/gnome/login-screen)" }
      - { path: '/etc/dconf/db/gdm.d/00-login-screen', regexp: "^(disable-user-list=true)" }
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).gdm_110_actual.gdm_110_actual | regex_search('(/login-screen)')) != "/login-screen" and ((database.stdout_lines[1]|from_json).gdm_110_actual.gdm_110_actual | regex_search('(banner-message-enable)')) != "banner-message-enable" and ((database.stdout_lines[1]|from_json).gdm_110_actual.gdm_110_actual | regex_search('(banner-message-text)')) != "banner-message-text" and ((database.stdout_lines[1]|from_json).gdm_110_actual.gdm_110_actual | regex_search('(gdm is not installed)')) != "gdm is not installed" and ((database.stdout_lines[1]|from_json).gdm_110_actual.gdm_110_actual | regex_search('(system-db:gdm)')) != "system-db:gdm"
    become: yes
    tags:
      - 1.10
      - gdm
      - one
      - all
      - rollback

##########CHAPTER2##########  

  - name: Rollback xinetd
    yum:
      name: xinetd
      state: present
    when: ((database.stdout_lines[1]|from_json).xinetd_211_actual.xinetd_211_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - xinetd
      - 2.1.1
      - two
      - all
      - rollback
      
  - name: Rollback timesync
    yum:
      name: chrony
      state: absent
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).timesync_2211_actual.timesync_2211_actual | regex_search('(chrony)')) != "chrony"
    become: yes
    tags:
      - timesync
      - 2.2.1.1
      - two
      - all
      - rollback
  
  - name: Rollback timesync
    yum:
      name: ntp
      state: absent
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).timesync_2211_actual.timesync_2211_actual | regex_search('(ntp)')) != "ntp"
    become: yes
    tags:
      - timesync
      - 2.2.1.1
      - two
      - all
      - rollback

  - name: Rollback chrony
    lineinfile:
      path: /etc/chrony.conf
      state: absent
      line: server {{ remote_server_chrony_oracle7 }}
    when: ((database.stdout_lines[1]|from_json).chrony_2212_actual.chrony_2212_actual | regex_search('(server)')) != "server" and ((database.stdout_lines[1]|from_json).chrony_2212_actual.chrony_2212_actual | regex_search('(OPTIONS)')) != "OPTIONS"
    become: yes
    tags:
      - chrony
      - 2.2.1.2
      - two
      - all
      - rollback

  - name: Rollback chrony
    replace:
      path: /etc/sysconfig/chronyd
      regexp: OPTIONS="-u chrony"
      replace: OPTIONS=""
    when: ((database.stdout_lines[1]|from_json).chrony_2212_actual.chrony_2212_actual | regex_search('(server)')) != "server" and ((database.stdout_lines[1]|from_json).chrony_2212_actual.chrony_2212_actual | regex_search('(OPTIONS)')) != "OPTIONS"
    become: yes
    tags:
      - chrony
      - 2.2.1.2
      - two
      - all      
      - rollback
      
  - name: Rollback ntp
    lineinfile:
       path: /etc/ntp.conf
       state: absent
       line: "{{item}}"
    with_items:
      - "restrict -4 default kod nomodify notrap nopeer noquery"
      - "restrict -6 default kod nomodify notrap nopeer noquery"
    when: ((database.stdout_lines[1]|from_json).ntp_2213_actual.ntp_2213_actual | regex_search('(restrict -4)')) != "restrict -4" and ((database.stdout_lines[1]|from_json).ntp_2213_actual.ntp_2213_actual | regex_search('(restrict -6)')) != "restrict -6"
    become: yes
    tags:
      - ntp
      - 2.2.1.3
      - two
      - all
      - rollback

  - name: Rollback ntp
    lineinfile:
       path: /etc/ntp.conf
       state: absent
       line: server {{ remote_server_ntp_oracle7 }}
    when: ((database.stdout_lines[1]|from_json).ntp_2213_actual.ntp_2213_actual | regex_search('(server)')) != "server" and ((database.stdout_lines[1]|from_json).ntp_2213_actual.ntp_2213_actual | regex_search('(pool)')) != "pool"
    become: yes
    tags:
      - ntp
      - 2.2.1.3
      - two
      - all
      - rollback

  - name: Rollback ntp
    lineinfile:
      path: /etc/sysconfig/ntpd
      state: absent
      regexp: 'OPTIONS="-u ntp:ntp"'
      line: 'OPTIONS=""'
    when: ((database.stdout_lines[1]|from_json).ntp_2213_actual.ntp_2213_actual | regex_search('(OPTIONS=)')) != "OPTIONS="
    become: yes
    tags:
      - ntp
      - 2.2.1.3
      - two
      - all
      - rollback

  - name: Rollback xorg
    yum:
      name: "{{item}}"
      state: present
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).xorg_222_actual.xorg_222_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).xorg_222_actual.xorg_222_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - xorg
      - 2.2.2
      - two
      - all
      - rollback
    
  - name: Rollback avahi
    yum:
      name: avahi-autoipd
      state: present
    when: ((database.stdout_lines[1]|from_json).avahi_223_actual.avahi_223_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - avahi
      - 2.2.3
      - two
      - all
      - rollback

  - name: Rollback avahi
    yum:
      name: avahi
      state: present
    when: ((database.stdout_lines[1]|from_json).avahi_223_actual.avahi_223_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - avahi
      - 2.2.3
      - two
      - all
      - rollback

  - name: Rollback avahi
    service:
      name: avahi-daemon.socket
      state: started
    when: ((database.stdout_lines[1]|from_json).avahi_223_actual.avahi_223_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - avahi
      - 2.2.3
      - two
      - all
      - rollback

  - name: Rollback avahi
    service:
      name: avahi-daemon.service
      state: started
    when: ((database.stdout_lines[1]|from_json).avahi_223_actual.avahi_223_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - avahi
      - 2.2.3
      - two
      - all    
      - rollback
      
  - name: Rollback cups
    yum:
      name: cups
      state: present
    when: ((database.stdout_lines[1]|from_json).cups_224_actual.cups_224_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - cups
      - 2.2.4
      - two
      - all
      - rollback

  - name: Rollback dhcp
    yum:
      name: dhcp
      state: present
    when: ((database.stdout_lines[1]|from_json).dhcp_225_actual.dhcp_225_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - dhcp
      - 2.2.5
      - two
      - all
      - rollback

  - name: Rollback ldap
    yum:
      name: openldap-servers
      state: present
    when: ((database.stdout_lines[1]|from_json).ldap_226_actual.ldap_226_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - ldap
      - 2.2.6
      - two
      - all
      - rollback

  - name: Rollback nfs
    yum:
      name: nfs-utils
      state: present
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nfs_227_actual.nfs_227_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - nfs
      - 2.2.7
      - two
      - all
      - rollback

  - name: Rollback rpcbind
    yum:
      name: rpcbind
      state: present
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).rpcbind_228_actual.rpcbind_228_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - rpcbind
      - 2.2.8
      - two
      - all
      - rollback

  - name: Rollback dns
    yum:
      name: bind
      state: present
    when: ((database.stdout_lines[1]|from_json).dns_229_actual.dns_229_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - dns
      - 2.2.9
      - two
      - all
      - rollback

  - name: Rollback ftp
    yum:
      name: vsftpd
      state: present
    when: ((database.stdout_lines[1]|from_json).ftp_2210_actual.ftp_2210_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - ftp
      - 2.2.10
      - two
      - all
      - rollback

  - name: Rollback http
    yum:
      name: httpd
      state: present
    when: ((database.stdout_lines[1]|from_json).http_2211_actual.http_2211_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - http
      - 2.2.11
      - two
      - all
      - rollback

  - name: Rollback imap
    yum:
      name: dovecot
      state: present
    when: ((database.stdout_lines[1]|from_json).imap_2212_actual.imap_2212_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - imap
      - 2.2.12
      - two
      - all
      - rollback

  - name: Rollback samba
    yum:
      name: samba
      state: present
    when: ((database.stdout_lines[1]|from_json).samba_2213_actual.samba_2213_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - samba
      - 2.2.13
      - two
      - all
      - rollback

  - name: Rollback proxy
    yum:
      name: squid
      state: present
    when: ((database.stdout_lines[1]|from_json).proxy_2214_actual.proxy_2214_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - proxy
      - 2.2.14
      - two
      - all
      - rollback

  - name: Rollback snmp
    yum:
      name: net-snmp
      state: present
    when: ((database.stdout_lines[1]|from_json).snmp_2215_actual.snmp_2215_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - snmp
      - 2.2.15
      - two
      - all
      - rollback

  - name: Rollback mail
    replace:
      path: /etc/postfix/main.cf
      regexp: "inet_interfaces = loopback-only"
      replace: "inet_interfaces = localhost"
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).mail_2216_actual.mail_2216_actual | regex_search('(loopback-only)')) != "loopback-only"
    become: yes
    tags:
      - mail
      - 2.2.16
      - two
      - all
      - rollback

  - name: Rollback mail
    systemd:
      name: postfix
      state: restarted
    failed_when: no      
    when: ((database.stdout_lines[1]|from_json).mail_2216_actual.mail_2216_actual | regex_search('(loopback-only)')) != "loopback-only"
    become: yes
    tags:
      - mail
      - 2.2.16
      - two
      - all
      - rollback

  - name: Rollback rsync
    yum:
      name: rsync
      state: present
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).rsync_2217_actual.rsync_2217_actual | regex_search('(not enabled)')) != "not enabled"
    become: yes
    tags:
      - rsync
      - 2.2.17
      - two
      - all
      - rollback

  - name: Rollback nis
    yum:
      name: ypserv
      state: present
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nis_2218_actual.nis_2218_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - nis
      - 2.2.18
      - two
      - all
      - rollback

  - name: Rollback telnet
    yum:
      name: telnet-server
      state: present
    when: ((database.stdout_lines[1]|from_json).telnet_2219_actual.telnet_2219_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - telnet
      - 2.2.19
      - two
      - all
      - rollback

  - name: Rollback nisc
    yum:
      name: ypbind
      state: present
    when: ((database.stdout_lines[1]|from_json).nisc_231_actual.nisc_231_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - nisc
      - 2.3.1
      - two
      - all
      - rollback

  - name: Rollback rshc
    yum:
      name: rsh
      state: present
    failed_when: no      
    when: ((database.stdout_lines[1]|from_json).rshc_232_actual.rshc_232_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - rshc
      - 2.3.2
      - two
      - all
      - rollback

  - name: Rollback talkc
    yum:
      name: talk
      state: present
    failed_when: no      
    when: ((database.stdout_lines[1]|from_json).talkc_233_actual.talkc_233_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - talkc
      - 2.3.3
      - two
      - all
      - rollback

  - name: Rollback telnetc
    yum:
      name: telnet
      state: present
    failed_when: no      
    when: ((database.stdout_lines[1]|from_json).telnetc_234_actual.telnetc_234_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - telnetc
      - 2.3.4
      - two
      - all
      - rollback

  - name: Rollback ldapc
    yum:
      name: openldap-clients
      state: present
    failed_when: no      
    when: ((database.stdout_lines[1]|from_json).ldapc_235_actual.ldapc_235_actual | regex_search('(not installed)')) != "not installed"
    become: yes
    tags:
      - ldapc
      - 2.3.5
      - two
      - all
      - rollback

  - name: Rollback nonessenserv
    yum:
      name: "{{ item }}"
      state: present
    failed_when: no
    loop: "{{ nonessen_service_oracle7.split(',') }}"
    when: ((database.stdout_lines[1]|from_json).nonessenserv_24_actual.nonessenserv_24_actual | regex_search('(nonessential)')) != "nonessential"
    become: yes
    tags:
      - 2.4
      - nonessenserv
      - two
      - all
      - rollback

 ###########CHAPTER3##########      
 
  - name: Rollback ipv6disable
    command: sed -i '/GRUB_CMDLINE_LINUX=/s/ipv6.disable=1//g' /etc/default/grub
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6disable_311_actual.ipv6disable_311_actual | regex_search('(disable=1)')) != "disable=1"
    become: yes
    tags:
      - ipv6disable
      - 3.1.1
      - three
      - all
      - rollback

  - name: Rollback ipv6disable
    shell: 'grub2-mkconfig > /boot/grub2/grub.cfg'
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6disable_311_actual.ipv6disable_311_actual | regex_search('(disable=1)')) != "disable=1"
    become: yes
    tags:
      - ipv6disable
      - 3.1.1
      - three
      - all
      - rollback
      
  - name: Rollback ipforward
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "net.ipv4.ip_forward=0"
    when: ((database.stdout_lines[1]|from_json).ipforward_321_actual.ipforward_321_actual | regex_search('(failed_ipv4)'))
    become: yes
    tags:
      - ipforward
      - 3.2.1
      - three
      - all
      - rollback

  - name: Rollback ipforward
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "net.ipv4.ip_forward=0"
      - "net.ipv6.conf.all.forwarding=0"
    when: ((database.stdout_lines[1]|from_json).ipforward_321_actual.ipforward_321_actual | regex_search('(failed_ipv_4_6)'))
    become: yes
    tags:
      - ipforward
      - 3.2.1
      - three
      - all
      - rollback

  - name: Rollback packetredirect
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.send_redirects=0"
      - "net.ipv4.conf.default.send_redirects=0"
    when: ((database.stdout_lines[1]|from_json).packetredirect_322_actual.packetredirect_322_actual | regex_search('(all)')) != "all" and ((database.stdout_lines[1]|from_json).packetredirect_322_actual.packetredirect_322_actual | regex_search('(default)')) != "default"
    become: yes
    tags:
      - packetredirect
      - 3.2.2
      - three
      - all      
      - rollback
      
  - name: Rollback routedpacket
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.accept_source_route=0"
      - "net.ipv4.conf.default.accept_source_route=0"
    when: ((database.stdout_lines[1]|from_json).routedpacket_331_actual.routedpacket_331_actual | regex_search('(failed_ipv4)'))
    become: yes
    tags:
      - routedpacket
      - 3.3.1
      - three
      - all
      - rollback

  - name: Rollback routedpacket
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.accept_source_route=0"
      - "net.ipv4.conf.default.accept_source_route=0"
      - "net.ipv6.conf.all.accept_source_route=0"
      - "net.ipv6.conf.default.accept_source_route=0"
    when: ((database.stdout_lines[1]|from_json).routedpacket_331_actual.routedpacket_331_actual | regex_search('(failed_ipv_4_6)'))
    become: yes
    tags:
      - routedpacket
      - 3.3.1
      - three
      - all
      - rollback

  - name: Rollback icmp
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.accept_redirects=0"
      - "net.ipv4.conf.default.accept_redirects=0"
    when: ((database.stdout_lines[1]|from_json).icmp_332_actual.icmp_332_actual | regex_search('(failed_ipv4)'))
    become: yes
    tags:
      - icmp
      - 3.3.2
      - three
      - all
      - rollback

  - name: Rollback icmp
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.accept_redirects=0"
      - "net.ipv4.conf.default.accept_redirects=0"
      - "net.ipv6.conf.default.accept_redirects=0"
      - "net.ipv6.conf.all.accept_redirects=0"
    when: ((database.stdout_lines[1]|from_json).icmp_332_actual.icmp_332_actual | regex_search('(failed_ipv_4_6)'))
    become: yes
    tags:
      - icmp
      - 3.3.2
      - three
      - rollback
      - all
      - rollback

  - name: Rollback secureicmp
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{ item }}"
    with_items:
      - "net.ipv4.conf.all.secure_redirects=0"
      - "net.ipv4.conf.default.secure_redirects=0"
    when: ((database.stdout_lines[1]|from_json).secureicmp_333_actual.secureicmp_333_actual | regex_search('(all)')) != "all" and ((database.stdout_lines[1]|from_json).secureicmp_333_actual.secureicmp_333_actual | regex_search('(default)')) != "default"
    become: yes
    tags:
      - secureicmp
      - 3.3.3
      - three
      - all      
      - rollback
      
  - name: Rollback suspicious
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "net.ipv4.conf.all.log_martians=1"
      - "net.ipv4.conf.default.log_martians=1"
    when: ((database.stdout_lines[1]|from_json).suspicious_334_actual.suspicious_334_actual | regex_search('(all)')) != "all" and ((database.stdout_lines[1]|from_json).suspicious_334_actual.suspicious_334_actual | regex_search('(default)')) != "default"
    become: yes
    tags:
      - suspicious
      - 3.3.4
      - three
      - all
      - rollback

  - name: Rollback broadcasticmp
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "net.ipv4.icmp_echo_ignore_broadcasts=1"
    when: ((database.stdout_lines[1]|from_json).broadcasticmp_335_actual.broadcasticmp_335_actual | regex_search('(broadcasts)')) != "broadcasts"
    become: yes
    tags:
      - broadcasticmp
      - 3.3.5
      - three
      - all
      - rollback

  - name: Rollback bogusicmp
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "net.ipv4.icmp_ignore_bogus_error_responses=1"
    when: ((database.stdout_lines[1]|from_json).bogusicmp_336_actual.bogusicmp_336_actual | regex_search('(bogus)')) != "bogus"
    become: yes
    tags:
      - bogusicmp
      - 3.3.6
      - three
      - all
      - rollback

  - name: Rollback reversepathfilter
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "net.ipv4.conf.all.rp_filter=1"
      - "net.ipv4.conf.default.rp_filter=1"
    when: ((database.stdout_lines[1]|from_json).reversepathfilter_337_actual.reversepathfilter_337_actual | regex_search('(all)')) != "all" and ((database.stdout_lines[1]|from_json).reversepathfilter_337_actual.reversepathfilter_337_actual | regex_search('(default)')) != "default"
    become: yes
    tags:
      - reversepathfilter
      - 3.3.7
      - three
      - all      
      - rollback
      
  - name: Rollback tcpsyncookies
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "net.ipv4.tcp_syncookies=1"
    when: ((database.stdout_lines[1]|from_json).tcpsyncookies_338_actual.tcpsyncookies_338_actual | regex_search('(syncookies)')) != "syncookies"
    become: yes
    tags:
      - tcpsyncookies
      - 3.3.8
      - three
      - all    
      - rollback
      
  - name: Rollback ipv6router
    lineinfile:
      path: /etc/sysctl.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "net.ipv6.conf.all.accept_ra=0"
      - "net.ipv6.conf.default.accept_ra=0"
    when: ((database.stdout_lines[1]|from_json).ipv6router_339_actual.ipv6router_339_actual | regex_search('(all)')) != "all" and ((database.stdout_lines[1]|from_json).ipv6router_339_actual.ipv6router_339_actual | regex_search('(default)')) != "default"
    become: yes
    tags:
      - ipv6router3
      - 3.3.9
      - three
      - all
      - rollback

  - name: Rollback dccp
    lineinfile:
      path: /etc/modprobe.d/dccp.conf
      state: absent
      regexp: "install dccp /bin/true"
    when: ((database.stdout_lines[1]|from_json).dccp_341_actual.dccp_341_actual | regex_search('(dccp)')) != "dccp"
    become: yes
    tags:
      - dccp
      - 3.4.1
      - three
      - all
      - rollback
      
  - name: Rollback sctp
    lineinfile:
      path: /etc/modprobe.d/sctp.conf
      state: absent
      regexp: "install sctp /bin/true"
    when: ((database.stdout_lines[1]|from_json).sctp_342_actual.sctp_342_actual | regex_search('(sctp)')) != "sctp"
    become: yes
    tags:
      - sctp
      - 3.4.2
      - three
      - all
      - rollback

  - name: Rollback firewallpack
    yum:
      name: firewalld
      state: absent
    when: ((database.stdout_lines[1]|from_json).firewallpack_3511_actual.firewallpack_3511_actual | regex_search('(firewalld-)')) != "firewalld-" and ((database.stdout_lines[1]|from_json).firewallpack_3511_actual.firewallpack_3511_actual | regex_search('(iptables-)')) != "iptables-"
    become: yes
    tags:
      - firewallpack
      - 3.5.1.1
      - three
      - all
      - rollback

  - name: Rollback firewallpack
    yum:
      name: iptables
      state: absent
    when: ((database.stdout_lines[1]|from_json).firewallpack_3511_actual.firewallpack_3511_actual | regex_search('(firewalld-)')) != "firewalld-" and ((database.stdout_lines[1]|from_json).firewallpack_3511_actual.firewallpack_3511_actual | regex_search('(iptables-)')) != "iptables-"
    become: yes
    tags:
      - firewallpack
      - 3.5.1.1
      - three
      - all
      - rollback
  
  - name: Rollback iptablesservfirewall
    yum:
      name: "{{ item }}"
      state: present
    with_items:
      - iptables
      - iptables-services
    when: ((database.stdout_lines[1]|from_json).iptablesservfirewall_3512_actual.iptablesservfirewall_3512_actual | regex_search('(iptables-services)')) != "iptables-services"
    become: yes
    tags:
      - iptablesservfirewall
      - 3.5.1.2
      - three
      - all
      - rollback

  - name: Rollback iptablesservfirewall
    systemd:
      name: iptables
      state: started
    when: ((database.stdout_lines[1]|from_json).iptablesservfirewall_3512_actual.iptablesservfirewall_3512_actual | regex_search('(iptables-services)')) != "iptables-services"
    failed_when: no
    become: yes
    tags:
      - iptablesservfirewall
      - 3.5.1.2
      - three
      - all
      - rollback

  - name: Rollback iptablesservfirewall
    systemd:
      name: ip6tables
      state: started
    when: ((database.stdout_lines[1]|from_json).iptablesservfirewall_3512_actual.iptablesservfirewall_3512_actual | regex_search('(iptables-services)')) != "iptables-services"
    failed_when: no
    become: yes
    tags:
      - iptablesservfirewall
      - 3.5.1.2
      - three
      - all
      - rollback

  - name: nftablesstop
    yum:
      name: nftables
      state: present
    when: ((database.stdout_lines[1]|from_json).nftablesstop_3513_actual.nftablesstop_3513_actual | regex_search('(nftables)')) != "nftables"
    become: yes
    tags:
      - nftablesstop
      - 3.5.1.3
      - three
      - all
      - rollback

  - name: Rollback firewallenb
    systemd:
      name: firewalld
      masked: yes
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).firewallenb_3514_actual.firewallenb_3514_actual | regex_search('(enabled)')) != "enabled" 
    become: yes
    tags:
      - firewallenb
      - 3.5.1.4
      - three
      - all
      - rollback

  - name: Rollback defaultzone
    command: firewall-cmd --get-default-zone={{ (database.stdout_lines[1]|from_json).defaultzone_3515_actual.defaultzone_3515_actual | regex_replace('failed ', '') }}
    when: ((database.stdout_lines[1]|from_json).defaultzone_3515_actual.defaultzone_3515_actual | regex_search('(public)')) != "public" and ((database.stdout_lines[1]|from_json).defaultzone_3515_actual.defaultzone_3515_actual | regex_search('(failed )'))
    become: yes
    tags:
      - defaultzone
      - 3.5.1.5
      - three
      - all
      - rollback

  - name: Rollback defaultzone
    command: firewall-cmd --permanent --delete-zone==public
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).defaultzone_3515_actual.defaultzone_3515_actual | regex_search('(public)')) != "public" and ((database.stdout_lines[1]|from_json).defaultzone_3515_actual.defaultzone_3515_actual | regex_search('(failed_command)')) != "failed_command"
    become: yes
    tags:
      - defaultzone
      - 3.5.1.5
      - three
      - all
      - rollback

  - name: Rollback netinterface
    command: firewall-cmd --delete-zone={{ zone_name_oracle7 }} --remove-interface={{ interface_name_oracle7 }}
    when: ((database.stdout_lines[1]|from_json).netinterface_3516_actual.netinterface_3516_actual | regex_search('(network interfaces)')) != "network interfaces"
    become: yes
    tags:
      - netinterface
      - 3.5.1.6
      - three
      - all
      - rollback

#  - name: Rollback unnecservport
#    firewalld:
#      service: "{{ item }}"
#      permanent: yes
#      state: enabled
#    loop: "{{ unnecservport_service_oracle7.split(',') }}"
#    when: ((database.stdout_lines[1]|from_json).unnecservport_3517_actual.unnecservport_3517_actual | regex_search('(unnecessary)')) != "unnecessary"
#    become: yes
#    tags:
#      - unnecservport
#      - 3.5.1.7
#      - three
#      - all
#      - rollback

#  - name: Rollback unnecservport
#    firewalld:
#      port: "{{ item }}"
#      permanent: yes
#      state: enabled
#    loop: "{{ unnecservport_port_oracle7.split(',') }}"
#    when: ((database.stdout_lines[1]|from_json).unnecservport_3517_actual.unnecservport_3517_actual | regex_search('(unnecessary)')) != "unnecessary"
#    become: yes
#    tags:
#      - unnecservport
#      - 3.5.1.7
#      - three
#      - all
#      - rollback
      
  - name: Rollback nftablesins
    yum:
      name: nftables
      state: absent
    when: ((database.stdout_lines[1]|from_json).nftablesins_3521_actual.nftablesins_3521_actual | regex_search('(nftables-)')) != "nftables-"
    become: yes
    tags:
      - nftablesins
      - 3.5.2.1
      - three
      - all
      - rollback

  - name: Rollback firewallno
    systemd:
      name: firewalld
      masked: no
    when: ((database.stdout_lines[1]|from_json).firewallno_3522_actual.firewallno_3522_actual | regex_search('(masked)')) != "masked"
    become: yes
    tags:
      - firewallno
      - 3.5.2.2
      - three
      - all
      - rollback

  - name: Rollback iptablesservnftables
    yum:
      name: iptables-services
      state: present
    when: ((database.stdout_lines[1]|from_json).iptablesservnftables_3523_actual.iptablesservnftables_3523_actual | regex_search('(iptables-services)')) != "iptables-services"
    become: yes
    tags:
      - iptablesservnftables
      - 3.5.2.3
      - three
      - all
      - rollback

  - name: Rollback iptablesservnftables
    systemd:
      name: iptables
      state: started
    when: ((database.stdout_lines[1]|from_json).iptablesservnftables_3523_actual.iptablesservnftables_3523_actual | regex_search('(iptables-services)')) != "iptables-services"
    become: yes
    tags:
      - iptablesservnftables
      - 3.5.2.3
      - three
      - all
      - rollback

  - name: Rollback iptablesservnftables
    systemd:
      name: ip6tables
      state: started
    when: ((database.stdout_lines[1]|from_json).iptablesservnftables_3523_actual.iptablesservnftables_3523_actual | regex_search('(iptables-services)')) != "iptables-services"
    become: yes
    tags:
      - iptablesservnftables
      - 3.5.2.3
      - three
      - all
      - rollback

  - name: Rollback iptablesflush
    shell: "{{item}}"
    with_items:
      - "iptables-restore < /etc/ansible/backup/iptablesflush/iptables_rules_{{ansible_hostname}}"
      - "ip6tables-restore < /etc/ansible/backup/iptablesflush/ip6tables_rules_{{ansible_hostname}}"
    when: ((database.stdout_lines[1]|from_json).iptablesflush_3524_actual.iptablesflush_3524_actual | regex_search('(iptables are flushed)')) != "iptables are flushed"
    become: yes
    tags:
      - 3.5.2.4
      - iptablesflush
      - three
      - all      
      - rollback
      
  - name: Rollback tablexists
    command: 'nft delete table inet "{{ table_name_oracle7 }}"'
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).tablexists_3525_actual.tablexists_3525_actual | regex_search('(table)')) != "table"
    become: yes
    tags:
      - tablexists
      - 3.5.2.5
      - three
      - all
      - rollback

  - name: Rollback basechains
    command: '{{ item }}'
    with_items:
      - nft delete chain inet {{ table_name_bc_oracle7 }} {{ base_chain_name_input_oracle7 }} { type filter hook input priority 0 \; }
      - nft delete chain inet {{ table_name_bc_oracle7 }} {{ base_chain_name_output_oracle7 }} { type filter hook output priority 0 \; }
      - nft delete chain inet {{ table_name_bc_oracle7 }} {{ base_chain_name_forward_oracle7 }} { type filter hook forward priority 0 \; }
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).basechains_3526_actual.basechains_3526_actual | regex_search('(input)')) != "input" and ((database.stdout_lines[1]|from_json).basechains_3526_actual.basechains_3526_actual | regex_search('(forward)')) != "forward" and ((database.stdout_lines[1]|from_json).basechains_3526_actual.basechains_3526_actual | regex_search('(output)')) != "output"
    become: yes
    tags:
      - basechains
      - 3.5.2.6
      - three
      - all
      - rollback
    
  - name: Rollback nfloopbacktraffic
    command: "{{ item }}"
    with_items:
      - nft delete rule inet filter input iif lo accept
      - nft delete rule inet filter input ip saddr 127.0.0.0/8 counter drop
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nfloopbacktraffic_3527_actual.nfloopbacktraffic_3527_actual | regex_search('(failed_ipv4)'))
    become: yes
    tags:
      - nfloopbacktraffic
      - 3.5.2.7
      - three
      - all
      - rollback

  - name: Rollback nfloopbacktraffic
    command: "{{ item }}"
    with_items:
      - nft delete rule inet filter input iif lo accept
      - nft delete rule inet filter input ip saddr 127.0.0.0/8 counter drop
      - nft delete rule inet filter INPUT ip6 saddr ::1 counter drop
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nfloopbacktraffic_3527_actual.nfloopbacktraffic_3527_actual | regex_search('(failed_ipv_4_6)'))
    become: yes
    tags:
      - nfloopbacktraffic
      - 3.5.2.7
      - three
      - all
      - rollback

  - name: Rollback nffirewallpolicy
    shell: nft -f /etc/ansible/backup/iptables_nft/nft_rules
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nffirewallpolicy_3529_actual.nffirewallpolicy_3529_actual | regex_search('(input)')) != "input" and ((database.stdout_lines[1]|from_json).nffirewallpolicy_3529_actual.nffirewallpolicy_3529_actual | regex_search('(forward)')) != "forward" and ((database.stdout_lines[1]|from_json).nffirewallpolicy_3529_actual.nffirewallpolicy_3529_actual | regex_search('(output)')) != "output"
    become: yes
    tags:
      - nffirewallpolicy
      - 3.5.2.9
      - three
      - all       
      - rollback
      
  - name: Rollback nftablesenb
    service:
      name: nftables
      enabled: no
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nftablesenb_35210_actual.nftablesenb_35210_actual | regex_search('(enabled)')) != "enabled"
    become: yes
    tags:
      - nftablesenb
      - 3.5.2.10
      - three
      - all
      - rollback

  - name: Rollback nftablesrules
    lineinfile:
      path: /etc/sysconfig/nftables.conf
      state: absent
      line: 'include "/etc/nftables/nftables.rules"'
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).nftablesrules_35211_actual.nftablesrules_35211_actual | regex_search('(hook)')) != "hook"
    become: yes
    tags:
      - nftablesrules
      - 3.5.2.11
      - three
      - all
      - rollback

  - name: Rollback iptables
    yum:
      name:
        - iptables
        - iptables-services
      state: absent
    when: ((database.stdout_lines[1]|from_json).iptables_35311_actual.iptables_35311_actual | regex_search('(iptables)')) != "iptables"
    become: yes
    tags:
      - iptables
      - 3.5.3.1.1
      - three
      - all
      - rollback

  - name: Rollback nftablesstopdup
    yum:
      name: nftables
      state: present
    when: ((database.stdout_lines[1]|from_json).nftablesstopdup_35312_actual.nftablesstopdup_35312_actual | regex_search('(nftables)')) != "nftables"
    become: yes
    tags:
      - nftablesstopdup
      - 3.5.3.1.2
      - three
      - all
      - rollback

  - name: Rollback firewallnodup
    systemd:
      name: firewalld
      masked: no
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).firewallnodup_35313_actual.firewallnodup_35313_actual | regex_search('(masked)')) != "masked"
    become: yes
    tags:
      - firewallnodup
      - 3.5.3.1.3
      - three
      - all      
      - rollback
      
  - name: Rollback firewallpolicy
    shell: iptables_restore < /etc/ansible/backup/iptables_nft/iptablesv4_rules
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).firewallpolicy_35321_actual.firewallpolicy_35321_actual | regex_search('(DROP)')) != "DROP" and ((database.stdout_lines[1]|from_json).firewallpolicy_35321_actual.firewallpolicy_35321_actual | regex_search('(REJECT)')) != "REJECT"
    become: yes
    tags:
      - firewallpolicy
      - 3.5.3.2.1
      - three
      - all  
      - rollback

  - name: Rollback loopbacktraffic
    command: "{{ item }}"
    with_items:
      - sudo iptables -D INPUT -i lo -j ACCEPT
      - sudo iptables -D OUTPUT -o lo -j ACCEPT
      - sudo iptables -D INPUT -s 127.0.0.0/8 -j DROP
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).loopbacktraffic_35322_actual.loopbacktraffic_35322_actual | regex_search('(all  --  lo)')) != "all  --  lo" and ((database.stdout_lines[1]|from_json).loopbacktraffic_35322_actual.loopbacktraffic_35322_actual | regex_search('(all  --  *)')) != "all  --  *" and ((database.stdout_lines[1]|from_json).loopbacktraffic_35322_actual.loopbacktraffic_35322_actual | regex_search('(127.0.0.0/8)')) != "127.0.0.0/8"
    become: yes
    tags:
      - loopbacktraffic
      - 3.5.3.2.2
      - three
      - all
      - rollback
      
  - name: Rollback firewallrules
    shell: iptables-restore < /etc/ansible/backup/iptables_nft/iptablesv4_fir_rules
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).firewallrules_35324_actual.firewallrules_35324_actual | regex_search('(tcp dpt)')) != "tcp dpt"
    become: yes
    tags:
      - firewallrules
      - 3.5.3.2.4
      - three
      - all
      - rollback

  - name: Rollback iptablesrules
    command: cp /etc/ansible/backup/iptables_nft/iptables_rules_save /etc/sysconfig/iptables
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).iptablerules_35325_actual.iptablerules_35325_actual | regex_search('(iptables rules are saved)')) != "iptables rules are saved"
    become: yes
    tags:
      - iptablesrules
      - 3.5.3.2.5
      - three
      - remedy
      - all

  - name: Rollback iptablesenb
    command: systemctl --now stop iptables
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).iptablesenb_35326_actual.iptablesenb_35326_actual | regex_search('(Active)')) != "Active"
    become: yes
    tags:
      - iptablesenb
      - 3.5.3.2.6
      - three
      - all
      - rollback
      
  - name: Rollback ipv6firewallpolicy
    shell: ip6tables-restore < /etc/ansible/backup/iptables_nft/iptablesv6_rules
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6firewallpolicy_35331_actual.ipv6firewallpolicy_35331_actual | regex_search('(INPUT)')) != "INPUT" and ((database.stdout_lines[1]|from_json).ipv6firewallpolicy_35331_actual.ipv6firewallpolicy_35331_actual | regex_search('(OUTPUT)')) != "OUTPUT" and ((database.stdout_lines[1]|from_json).ipv6firewallpolicy_35331_actual.ipv6firewallpolicy_35331_actual | regex_search('(FORWARD)')) != "FORWARD" and ((database.stdout_lines[1]|from_json).ipv6firewallpolicy_35331_actual.ipv6firewallpolicy_35331_actual | regex_search('(ipv6 is disabled)')) != "ipv6 is disabled"
    become: yes
    tags:
      - ipv6firewallpolicy
      - 3.5.3.3.1
      - rolbackthree
      - all    
      - rollback
      
  - name: Rollback ipv6loopbacktraffic
    command: "{{ item }}"
    with_items:
      - ip6tables -D INPUT -i lo -j ACCEPT
      - ip6tables -D OUTPUT -o lo -j ACCEPT
      - ip6tables -D INPUT -s ::1 -j DROP
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6loopbacktraffic_35332_actual.ipv6loopbacktraffic_35332_actual | regex_search('(ACCEPT     all      lo)')) != "ACCEPT     all      lo" and ((database.stdout_lines[1]|from_json).ipv6loopbacktraffic_35332_actual.ipv6loopbacktraffic_35332_actual | regex_search('(ACCEPT     all      *)')) != "ACCEPT     all      *" and ((database.stdout_lines[1]|from_json).ipv6loopbacktraffic_35332_actual.ipv6loopbacktraffic_35332_actual | regex_search('(ipv6 is disabled)')) != "ipv6 is disabled"
    become: yes
    tags:
      - ipv6loopbacktraffic
      - 3.5.3.3.2
      - three
      - all
      - rollback

  - name: Rollback ipv6firewallrules
    shell: ip6tables-restore < /etc/ansible/backup/iptables_nft/iptablesv6_fir_rules
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6firewallrules_35334_actual.ipv6firewallrules_35334_actual | regex_search('(tcp)')) != "tcp" and ((database.stdout_lines[1]|from_json).ipv6firewallrules_35334_actual.ipv6firewallrules_35334_actual | regex_search('(ipv6 is disabled)')) != "ipv6 is disabled"
    become: yes
    tags:
      - ipv6firewallrules
      - 3.5.3.3.4
      - three
      - all
      - rollback

  - name: Rollback ipv6tablesrules
    shell: cp /etc/ansible/backup/iptables_nft/ip6tables_rules_save  /etc/sysconfig/ip6tables
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ipv6tablesrules_35335_actual.ipv6tablesrules_35335_actual | regex_search('(ip6tables rules are saved)')) != "ipv6tables rules are saved" and ((database.stdout_lines[1]|from_json).ipv6tablesrules_35335_actual.ipv6tablesrules_35335_actual | regex_search('(ipv6 is disabled)') != "ipv6 is disabled"
    become: yes
    tags:
      - ipv6tablesrules
      - 3.5.3.3.5
      - three
      - rollback
      - all

  - name: Rollback ip6tablesenb
    command: systemctl --now stop ip6tables
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).ip6tablesenb_35336_actual.ip6tablesenb_35336_actual | regex_search('(Active)')) != "Active" and ((database.stdout_lines[1]|from_json).ip6tablesenb_35336_actual.ip6tablesenb_35336_actual | regex_search('(ipv6 is disabled)')) != "ipv6 is disabled"
    become: yes
    tags:
      - ip6tablesenb
      - 3.5.3.3.6
      - three
      - all      
      - rollback
 
##############CHAPTER4####### 
 
  - name: Rollback auditd
    dnf: name=auditd state=absent
    when: ((database.stdout_lines[1]|from_json).auditd_4111_actual.auditd_4111_actual | regex_search('(audit-)')) != "audit-" and ((database.stdout_lines[1]|from_json).auditd_4111_actual.auditd_4111_actual | regex_search('(audit-libs)')) != "audit-libs"
    become: yes
    tags:
      - auditd
      - 4.1.1.1
      - four
      - all
      - rollback

  - name: Rollback auditd
    dnf: name=audit-libs state=absent
    when: ((database.stdout_lines[1]|from_json).auditd_4111_actual.auditd_4111_actual | regex_search('(audit-)')) != "audit-" and ((database.stdout_lines[1]|from_json).auditd_4111_actual.auditd_4111_actual | regex_search('(audit-libs)')) != "audit-libs"
    become: yes
    tags:
      - auditd
      - 4.1.1.1
      - four
      - all
      - rollback
    
  - name: Rollback auditdservice
    service: name=auditd enabled=no
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).auditdservice_4112_actual.auditdservice_4112_actual | regex_search('(enabled)')) != "enabled"
    become: yes
    tags:
      - auditdservice
      - 4.1.1.2
      - four
      - all
      - rollback
      
  - name: Rollback auditdenable
    command: sed -i '/GRUB_CMDLINE_LINUX=/s/audit=1//g' /etc/default/grub
    when: ((database.stdout_lines[1]|from_json).auditdenable_4113_actual.auditdenable_4113_actual | regex_search('(audit=1)')) != "audit=1"
    become: yes
    tags:
      - auditdenable
      - 4.1.1.3
      - four
      - all    
      - rollback
      
  - name: Rollback auditlogsize
    replace:
      path: /etc/audit/auditd.conf
      regexp: "^(max_log_file =*)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).auditlogsize_4121_actual.auditlogsize_4121_actual | regex_search('(max_log_file)')) != "max_log_file"
    become: yes
    failed_when: no
    tags:
      - auditlogsize
      - 4.1.2.1
      - four
      - all
      - rollback

  - name: Rollback auditlogdelete
    replace:
      path: /etc/audit/auditd.conf
      regexp: "max_log_file_action = keep_logs"
      replace: "max_log_file_action = ROTATE"
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).auditlogdelete_4122_actual.auditlogdelete_4122_actual | regex_search('(keep_logs)')) != "keep_logs"
    become: yes
    tags:
      - auditlogdelete
      - 4.1.2.2
      - four
      - all    
      - rollback
      
  - name: Rollback sysdisable
    replace:
      path: /etc/audit/auditd.conf
      regexp: "{{item.regexp}}"
      replace: "{{item.replace}}"
    failed_when: no
    with_items:
      - { regexp: space_left_action = email, replace: space_left_action = SYSLOG }
      - { regexp: admin_space_left_action = halt, replace: admin_space_left_action = SUSPEND }
      - { regexp: '^(action_mail_acct = root)', replace: '#\1' }
    when: ((database.stdout_lines[1]|from_json).sysdisable_4123_actual.sysdisable_4123_actual | regex_search('(email)')) != "email" and ((database.stdout_lines[1]|from_json).sysdisable_4123_actual.sysdisable_4123_actual | regex_search('(halt)')) != "halt" and ((database.stdout_lines[1]|from_json).sysdisable_4123_actual.sysdisable_4123_actual | regex_search('(root)')) != "root"
    become: yes
    tags:
      - sysdisable
      - 4.1.2.3
      - four
      - all
      - rollback

  - name: Rollback auditdbacklog
    command: sed -i '/GRUB_CMDLINE_LINUX=/s/audit_backlog_limit=8192//g' /etc/default/grub
    when: ((database.stdout_lines[1]|from_json).auditdbacklog_4124_actual.auditdbacklog_4124_actual | regex_search('(audit_backlog_limit=8192)')) != "audit_backlog_limit=8192"
    become: yes
    tags:
      - auditdbacklog
      - 4.1.2.4
      - four
      - all
      - rollback

  - name: Rollback auditdbacklog
    command: grub2-mkconfig -o /boot/grub2/grub.cfg
    when: ((database.stdout_lines[1]|from_json).auditdbacklog_4124_actual.auditdbacklog_4124_actual | regex_search('(audit_backlog_limit=8192)')) != "audit_backlog_limit=8192"
    become: yes
    tags:
      - auditdbacklog
      - 4.1.2.4
      - four
      - all
      - rollback
      
  - name: Rollback moddatetime(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/time_change.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S adjtimex -S settimeofday -k time-change"
      - "-a always,exit -F arch=b32 -S adjtimex -S settimeofday -S stime -k time-change"
      - "-a always,exit -F arch=b64 -S clock_settime -k time-change"
      - "-a always,exit -F arch=b32 -S clock_settime -k time-change"
      - "-w /etc/localtime -p wa -k time-change"
    when: ((database.stdout_lines[1]|from_json).moddatetime_413_actual.moddatetime_413_actual | regex_search('(settimeofday)')) != "settimeofday" and ((database.stdout_lines[1]|from_json).moddatetime_413_actual.moddatetime_413_actual | regex_search('(clock_settime)')) != "clock_settime" and ((database.stdout_lines[1]|from_json).moddatetime_413_actual.moddatetime_413_actual | regex_search('(/localtime)')) != "/localtime"
    become: yes
    tags:
      - moddatetime
      - 4.1.3
      - four
      - all    
      - rollback
      
  - name: Rollback modusergrp
    lineinfile:
      path: /etc/audit/rules.d/identity.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-w /etc/group -p wa -k identity"
      - "-w /etc/passwd -p wa -k identity"
      - "-w /etc/gshadow -p wa -k identity"
      - "-w /etc/shadow -p wa -k identity"
      - "-w /etc/security/opasswd -p wa -k identity"
    when: ((database.stdout_lines[1]|from_json).modusergrp_414_actual.modusergrp_414_actual | regex_search('(/etc/group)')) != "/etc/group" and ((database.stdout_lines[1]|from_json).modusergrp_414_actual.modusergrp_414_actual | regex_search('(/etc/passwd)')) != "/etc/passwd" and ((database.stdout_lines[1]|from_json).modusergrp_414_actual.modusergrp_414_actual | regex_search('(/etc/gshadow)')) != "/etc/gshadow" and ((database.stdout_lines[1]|from_json).modusergrp_414_actual.modusergrp_414_actual | regex_search('(/etc/shadow)')) != "/etc/shadow" and ((database.stdout_lines[1]|from_json).modusergrp_414_actual.modusergrp_414_actual | regex_search('(/etc/security)')) != "/etc/security"
    become: yes
    tags:
      - modusergrp
      - 4.1.4
      - four
      - all
      - rollback
      
  - name: Rollback modsysnet(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/system_local.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S sethostname -S setdomainname -k system-locale"
      - "-a always,exit -F arch=b32 -S sethostname -S setdomainname -k system-locale"
      - "-w /etc/issue -p wa -k system-locale"
      - "-w /etc/issue.net -p wa -k system-locale"
      - "-w /etc/hosts -p wa -k system-locale"
      - "-w /etc/network -p wa -k system-locale"
    when: ((database.stdout_lines[1]|from_json).modsysnet_415_actual.modsysnet_415_actual | regex_search('(setdomainname)')) != "setdomainname" and ((database.stdout_lines[1]|from_json).modsysnet_415_actual.modsysnet_415_actual | regex_search('(/etc/issue)')) != "/etc/issue" and ((database.stdout_lines[1]|from_json).modsysnet_415_actual.modsysnet_415_actual | regex_search('(/etc/issue.net)')) != "/etc/issue.net" and ((database.stdout_lines[1]|from_json).modsysnet_415_actual.modsysnet_415_actual | regex_search('(/hosts)')) != "/hosts" and ((database.stdout_lines[1]|from_json).modsysnet_415_actual.modsysnet_415_actual | regex_search('(/sysconfig/network)')) != "/sysconfig/network"
    become: yes
    tags:
      - modsysnet
      - 4.1.5
      - four
      - all  
      - rollback

  - name: Rollback modsysmac
    lineinfile:
      path: /etc/audit/rules.d/MAC_policy.rules
      state: absent
      line: "{{item}}"
    with_items:
      - '-w /etc/selinux/ -p wa -k MAC-policy'
      - '-w /usr/share/selinux/ -p wa -k MAC-policy'
    when: ((database.stdout_lines[1]|from_json).modsysmac_416_actual.modsysmac_416_actual | regex_search('(/etc/selinux)')) != "/etc/selinux" and ((database.stdout_lines[1]|from_json).modsysmac_416_actual.modsysmac_416_actual | regex_search('(/usr/share/selinux/)')) != "/usr/share/selinux/"
    become: yes
    tags:
      - modsysmac
      - 4.1.6
      - four
      - all    
      - rollback
      
  - name: Rollback loginout
    lineinfile:
      path: /etc/audit/rules.d/logins.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-w /var/log/lastlog -p wa -k logins"
      - "w /var/log/lastlog -p wa -k logins"
    when: ((database.stdout_lines[1]|from_json).loginout_417_actual.loginout_417_actual | regex_search('(logins)')) != "logins"
    become: yes
    tags:
      - loginout
      - 4.1.7
      - four
      - all
      - rollback
      
  - name: Rollback session
    lineinfile:
      path: /etc/audit/rules.d/session.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-w /var/run/utmp -p wa -k session"
      - "-w /var/log/wtmp -p wa -k logins"
      - "-w /var/log/btmp -p wa -k logins"
    when: ((database.stdout_lines[1]|from_json).session_418_actual.session_418_actual | regex_search('(session)')) != "session" and ((database.stdout_lines[1]|from_json).session_418_actual.session_418_actual | regex_search('(logins)')) != "logins"
    become: yes
    tags:
      - session
      - 4.1.8
      - four
      - all
      - rollback
      
  - name: Rollback dacperm(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/perm_mod.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod"
      - "-a always,exit -F arch=b32 -S chmod -S fchmod -S fchmodat -F auid>=1000 -F auid!=4294967295 -k perm_mod"
      - "-a always,exit -F arch=b64 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod"
      - "-a always,exit -F arch=b32 -S chown -S fchown -S fchownat -S lchown -F auid>=1000 -F auid!=4294967295 -k perm_mod"
      - "-a always,exit -F arch=b64 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod"
      - "-a always,exit -F arch=b32 -S setxattr -S lsetxattr -S fsetxattr -S removexattr -S lremovexattr -S fremovexattr -F auid>=1000 -F auid!=4294967295 -k perm_mod"
    when: ((database.stdout_lines[1]|from_json).dacperm_419_actual.dacperm_419_actual | regex_search('(fchmodat)')) != "fchmodat" and ((database.stdout_lines[1]|from_json).dacperm_419_actual.dacperm_419_actual | regex_search('(fchownat)')) != "fchownat" and ((database.stdout_lines[1]|from_json).dacperm_419_actual.dacperm_419_actual | regex_search('(removexattr)')) != "removexattr"
    become: yes
    tags:
      - dacperm
      - 4.1.9
      - four
      - all
      - rollback
      
  - name: Rollback fileaccess(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/access.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access"
      - "-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EACCES -F auid>=1000 -F auid!=4294967295 -k access"
      - "-a always,exit -F arch=b64 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access"
      - "-a always,exit -F arch=b32 -S creat -S open -S openat -S truncate -S ftruncate -F exit=-EPERM -F auid>=1000 -F auid!=4294967295 -k access"
    when: ((database.stdout_lines[1]|from_json).fileaccess_4110_actual.fileaccess_4110_actual | regex_search('(EACCES)')) != "EACCES" and ((database.stdout_lines[1]|from_json).fileaccess_4110_actual.fileaccess_4110_actual | regex_search('(EPERM)')) != "EPERM"
    become: yes
    tags:
      - fileaccess
      - 4.1.10
      - four
      - all
      - rollback
      
  - name: Rollback privilegecmd
    file:
      path: /etc/audit/rules.d/privileged.rules
      state: absent
    when: ((database.stdout_lines[1]|from_json).privilegecmd_4111_actual.privilegecmd_4111_actual | regex_search('(privileged)')) != "privileged"
    become: yes
    tags:
      - privilegecmd
      - 4.1.11
      - four
      - all
      - rollback
      
  - name: Rollback fsmount(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/mounts.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts"
      - "-a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts"
    when: ((database.stdout_lines[1]|from_json).fsmount_4112_actual.fsmount_4112_actual | regex_search('(mounts)')) != "mounts" and ((database.stdout_lines[1]|from_json).fsmount_4112_actual.fsmount_4112_actual | regex_search('(mounts)')) != "mounts"
    become: yes
    tags:
      - fsmount
      - 4.1.12
      - four
      - all
      - rollback

  - name: Rollback filedeletion(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/delete.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-a always,exit -F arch=b64 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete"
      - "-a always,exit -F arch=b32 -S unlink -S unlinkat -S rename -S renameat -F auid>=1000 -F auid!=4294967295 -k delete"
    when: ((database.stdout_lines[1]|from_json).filedeletion_4113_actual.filedeletion_4113_actual | regex_search('(unlinkat)')) != "unlinkat"
    become: yes
    tags:
      - filedeletion
      - 4.1.13
      - four
      - all
      - rollback

  - name: Rollback sudoers
    lineinfile:
      path: /etc/audit/rules.d/scope.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-w /etc/sudoers -p wa -k scope"
      - "-w /etc/sudoers.d/ -p wa -k scope"
    when: ((database.stdout_lines[1]|from_json).sudoers_4114_actual.sudoers_4114_actual | regex_search('(/sudoers)')) != "/sudoers" and ((database.stdout_lines[1]|from_json).sudoers_4114_actual.sudoers_4114_actual | regex_search('(/sudoers.d)')) != "sudoers.d"
    become: yes
    tags:
      - sudoers
      - 4.1.14
      - four
      - all
      - rollback

  - name: Rollback sudolog
    lineinfile:
      path: /etc/audit/rules.d/actions.rules
      state: absent
      line: "-w /var/log/sudo.log -p wa -k actions"
    when: ((database.stdout_lines[1]|from_json).sudolog_4115_actual.sudolog_4115_actual | regex_search('(sudo.log)')) != "sudo.log"
    become: yes
    tags:
      - sudolog
      - 4.1.15
      - four
      - all
      - rollback

  - name: Rollback kernelmodule(arch-64&32)
    lineinfile:
      path: /etc/audit/rules.d/modules.rules
      state: absent
      line: "{{item}}"
    with_items:
      - "-w /sbin/insmod -p x -k modules"
      - "-w /sbin/rmmod -p x -k modules"
      - "-w /sbin/modprobe -p x -k modules"
      - "-a always,exit -F arch=b64 -S init_module -S delete_module -k modules"
      - "-a always,exit -F arch=b32 -S init_module -S delete_module -k modules"
    when: ((database.stdout_lines[1]|from_json).kernelmodule_4116_actual.kernelmodule_4116_actual | regex_search('(insmod)')) != "insmod" and ((database.stdout_lines[1]|from_json).kernelmodule_4116_actual.kernelmodule_4116_actual | regex_search('(rmmod)')) != "rmmod" and ((database.stdout_lines[1]|from_json).kernelmodule_4116_actual.kernelmodule_4116_actual | regex_search('(modprobe)')) != "modprobe" and ((database.stdout_lines[1]|from_json).kernelmodule_4116_actual.kernelmodule_4116_actual | regex_search('(init_module)')) != "init_module"
    become: yes
    tags:
      - kernelmodule
      - 4.1.16
      - four
      - all
      - rollback

  - name: Rollback auditconfig
    lineinfile:
      path: /etc/audit/rules.d/99-finalize.rules
      state: absent
      line: "-e 2"
    when: ((database.stdout_lines[1]|from_json).auditconfig_4117_actual.auditconfig_4117_actual | regex_search('(-e 2)')) != "-e 2"
    become: yes
    tags:
      - auditconfig
      - 4.1.17
      - four
      - all
      - rollback
      
  - name: Rollback rsyslog
    dnf: name=rsyslog state=absent
    when: ((database.stdout_lines[1]|from_json).rsyslog_4211_actual.rsyslog_4211_actual | regex_search('(rsyslog-)')) != "rsyslog-"
    become: yes
    tags:
      - rsyslog
      - 4.2.1.1
      - four
      - all    
      - rollback
      
  - name: Rollback rsyslogenb
    service:
      name: rsyslog
      enabled: no
    when: ((database.stdout_lines[1]|from_json).rsyslogenb_4212_actual.rsyslogenb_4212_actual | regex_search('(enabled)')) != "enabled"
    become: yes
    tags:
      - rsyslogenb
      - 4.2.1.2
      - four
      - all    
      - rollback
      
  - name: Rollback rsyslogperm
    shell: sed -i 's/^\$FileCreateMode 0640/#$FileCreateMode 0640/g' /etc/rsyslog.conf /etc/rsyslog.d/*.conf
    when: ((database.stdout_lines[1]|from_json).rsyslogperm_4213_actual.rsyslogperm_4213_actual | regex_search('(0640)')) != "0640"
    become: yes
    tags:
      - rsyslogperm
      - 4.2.1.3
      - four
      - all
      - rollback
      
  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "*.emerg :omusrmsg:*"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(.emerg :)')) != ".emerg :"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "auth,authpriv.* /var/log/secure"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(auth,authpriv.* /var/log/secure)')) != "auth,authpriv.* /var/log/secure"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "mail.* -/var/log/mail"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(mail.*                                                  -/var/log/mail)')) !=  "mail.*                            -/var/log/mail"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "mail.info -/var/log/mail.info"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(mail.info -/var/log/mail.info)')) != "mail.info -/var/log/mail.info"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "mail.warning -/var/log/mail.warn"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(mail.warning -/var/log/mail.warn)')) != "mail.warning -/var/log/mail.warn"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "mail.err /var/log/mail.err"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(mail.err /var/log/mail.err)')) != "mail.err /var/log/mail.err"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "news.crit -/var/log/news/news.crit"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(news.crit -/var/log/news/news.crit)')) != "news.crit -/var/log/news/news.crit"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "news.err -/var/log/news/news.err"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(news.err -/var/log/news/news.err)')) != "news.err -/var/log/news/news.err"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "news.notice -/var/log/news/news.notice"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(news.notice -/var/log/news/news.notice)')) != "news.notice -/var/log/news/news.notice"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "*.=warning;*.=err -/var/log/warn"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(=warning;)')) != "=warning;"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "*.crit /var/log/warn"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(crit /var/log/warn)')) != "crit /var/log/warn"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "*.*;mail.none;news.none -/var/log/messages"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(;mail.none;news.none)')) != ";mail.none;news.none"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "local0,local1.* -/var/log/localmessages"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(local0,local1)')) != "local0,local1"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "local2,local3.* -/var/log/localmessages"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(local2,local3)')) != "local2,local3"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "local4,local5.* -/var/log/localmessages"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(local4,local5)')) != "local4,local5"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rloggingconf
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "{{item}}"
    with_items:
      - "local6,local7.* -/var/log/localmessages"
    when: ((database.stdout_lines[1]|from_json).rloggingconf_4214_actual.rloggingconf_4214_actual | regex_search('(local6,local7)')) != "local6,local7"
    become: yes
    tags:
      - rloggingconf
      - 4.2.1.4
      - four
      - all
      - rollback

  - name: Rollback rsyslogsendlogs
    lineinfile:
      path: /etc/rsyslog.conf
      state: absent
      line: "*.* @@loghost.example.com"
    when: ((database.stdout_lines[1]|from_json).rsyslogsendlogs_4215_actual.rsyslogsendlogs_4215_actual | regex_search('( @@)')) != " @@"
    become: yes
    tags:
      - rsyslogsendlogs
      - 4.2.1.5
      - four
      - rollback
      - all
      - rollback

  - name: Rollback rsyslogsendlogs
    command: find /etc/rsyslog.d/ -name "*.conf"
    register: rsyslogsendlogs_roll
    when: ((database.stdout_lines[1]|from_json).rsyslogsendlogs_4215_actual.rsyslogsendlogs_4215_actual | regex_search('( @@)')) != " @@"
    become: yes
    tags:
      - rsyslogsendlogs
      - 4.2.1.5
      - four
      - all
      - rollback
      - rollback

  - name: Rollback rsyslogsendlogs
    lineinfile:
      path: '{{ item }}'
      state: absent
      line: "*.* @@loghost.example.com"
    loop: '{{ rsyslogsendlogs_roll.stdout_lines }}'
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).rsyslogsendlogs_4215_actual.rsyslogsendlogs_4215_actual | regex_search('( @@)')) != " @@"   
    become: yes
    tags:
      - rsyslogsendlogs
      - 4.2.1.5
      - four
      - all
      - rollback

  - name: Rollback remotesyslogmsg
    shell: sed -i 's/^\$ModLoad imtcp/#$ModLoad imtcp/g' /etc/rsyslog.conf /etc/rsyslog.d/*.conf
    when: ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(ModLoad imtcp)')) != "ModLoad imtcp" and ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(InputTCPServerRun)')) != "InputTCPServerRun"
    become: yes
    tags:
      - remotesyslogmsg
      - 4.2.1.6
      - four
      - rollback
      - all
      - rollback

  - name: Rollback remotesyslogmsg
    shell: sed -i 's/^\$InputTCPServerRun 514/#$InputTCPServerRun 514/g' /etc/rsyslog.conf /etc/rsyslog.d/*.conf
    when: ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(ModLoad imtcp)')) != "ModLoad imtcp" and ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(InputTCPServerRun)')) != "InputTCPServerRun"
    become: yes
    tags:
      - remotesyslogmsg
      - 4.2.1.6
      - four
      - rollback
      - all
      - rollback
      
  - name: Rollback remotesyslogmsg
    command: "pkill -HUP rsyslogd"
    when: ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(ModLoad imtcp)')) != "ModLoad imtcp" and ((database.stdout_lines[1]|from_json).remotesyslogmsg_4216_actual.remotesyslogmsg_4216_actual | regex_search('(InputTCPServerRun)')) != "InputTCPServerRun"
    become: yes
    tags:
      - remotesyslogmsg
      - 4.2.1.6
      - four
      - all     
      - rollback
  
  - name: Rollback journalsendlogs
    replace:
      path: /etc/systemd/journald.conf
      regexp: "ForwardToSyslog=yes"
      replace: "#ForwardToSyslog=no"
    when: ((database.stdout_lines[1]|from_json).journalsendlogs_4221_actual.journalsendlogs_4221_actual | regex_search('(ForwardToSyslog)')) != "ForwardToSyslog"
    become: yes
    tags:
      - journalsendlogs
      - 4.2.2.1
      - four
      - all
      - rollback

  - name: Rollback journalcompresslog
    replace:
      path: /etc/systemd/journald.conf
      regexp: "^Compress=yes"
      replace: "#Compress=yes"
    when: ((database.stdout_lines[1]|from_json).journalcompresslog_4222_actual.journalcompresslog_4222_actual | regex_search('(Compress)')) != "Compress"
    become: yes
    tags:
      - journalcompresslog
      - 4.2.2.2
      - four
      - all
      - rollback

  - name: Rollback journalpersisdisk
    replace:
      path: /etc/systemd/journald.conf
      regexp: "Storage=persistent"
      replace: "#Storage=auto"
    when: ((database.stdout_lines[1]|from_json).journalpersisdisk_4223_actual.journalpersisdisk_4223_actual | regex_search('(Storage)')) != "Storage"
    become: yes
    tags:
      - journalpersisdisk
      - 4.2.2.3
      - four
      - all
      - rollback
      
  - name: Rollback permlogfiles
    file:
      path: "{{ item |  regex_search('/.*') }}"
      mode: "{{ item |  regex_search('[0-9]+') }}"
    loop: "{{ (database.stdout_lines[1]|from_json).permlogfiles_423_actual.permlogfiles_423_actual.split(',') | regex_replace('failed ', '') }}"
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).permlogfiles_423_actual.permlogfiles_423_actual | regex_search('(Permissions)')) != "Permissions"
    become: yes
    tags:
      - 4.2.3
      - permlogfiles
      - four
      - all
      - rollback

  - name: Rollback logrotate
    shell: "sed -i 's/{{ item }}//g' /etc/logrotate.conf /etc/logrotate.d/*"
    with_items:
      - "# Specifies the number of days after which old log files should be removed"
      - "maxage 90"
    when: ((database.stdout_lines[1]|from_json).logrotate_424_actual.logrotate_424_actual | regex_search('(maxage)')) != "maxage"
    become: yes
    tags:
      - logrotate
      - 4.2.4
      - four
      - all
      - rollback
      
  - name: Rollback cron
    service:
      name: crond
      enabled: no
    when: ((database.stdout_lines[1]|from_json).cron_511_actual.cron_511_actual | regex_search('(enabled)')) != "enabled"
    become: yes
    tags:
      - cron
      - 5.1.1
      - five
      - all    
      - rollback
      
  - name: Rollback permcrontab
    file:
      path: "/etc/crontab"
      mode: 0644
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcrontab_512_actual.permcrontab_512_actual | regex_search('(/etc/crontab)')) != "/etc/crontab"
    become: yes
    tags:
      - permcrontab
      - 5.1.2
      - five
      - all    
      - rollback
      
  - name: Rollback permcronhourly
    file:
      path: "/etc/cron.hourly"
      mode: 0755
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcronhourly_513_actual.permcronhourly_513_actual | regex_search('(/etc/cron.hourly)')) != "/etc/cron.hourly"
    become: yes
    tags:
      - permcronhourly
      - 5.1.3
      - five
      - all    
      - rollback
      
  - name: Rollback permcrondaily 
    file:
      path: "/etc/cron.daily"
      mode: 0755
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcrondaily_514_actual.permcrondaily_514_actual | regex_search('(/etc/cron.daily)')) != "/etc/cron.daily"
    become: yes
    tags:
      - permcrondaily
      - 5.1.4
      - five
      - all
      - rollback

  - name: Rollback permcronweekly
    file:
      path: "/etc/cron.weekly"
      mode: 0755
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcronweekly_515_actual.permcronweekly_515_actual | regex_search('(/etc/cron.weekly)')) != "/etc/cron.weekly"
    become: yes
    tags:
      - permcronweekly
      - 5.1.5
      - five
      - all
      - rollback

  - name: Rollback permcronmonthly
    file:
      path: "/etc/cron.monthly"
      mode: 0755
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcronmonthly_516_actual.permcronmonthly_516_actual | regex_search('(/etc/cron.monthly)')) != "/etc/cron.monthly"
    become: yes
    tags:
      - permcronmonthly
      - 5.1.6
      - five
      - all
      - rollback

  - name: Rollback permcrond
    file:
      path: "/etc/cron.d"
      mode: 0755
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permcrond_517_actual.permcrond_517_actual | regex_search('(/etc/cron.d)')) != "/etc/cron.d"
    become: yes
    tags:
      - permcrond
      - 5.1.7
      - five
      - all
      - rollback
      
  - name: Rollback cronuser
    copy:
      src: '/etc/ansible/backup/cronuser/cron_deny_{{ansible_hostname}}'
      dest: /etc/cron.deny
      remote_src: yes
    when: ((database.stdout_lines[1]|from_json).cronuser_518_actual.cronuser_518_actual | regex_search('(/etc/cron.allow)')) != "/etc/cron.allow"
    failed_when: no
    become: yes
    tags:
      - cronuser
      - 5.1.8
      - five
      - all
      - rollback

  - name: Rollback cronuser
    file:
      path: "/etc/cron.allow"
      state: absent
    when: ((database.stdout_lines[1]|from_json).cronuser_518_actual.cronuser_518_actual | regex_search('(/etc/cron.allow)')) != "/etc/cron.allow"
    become: yes
    tags:
      - cronuser
      - 5.1.8
      - five
      - all
      - rollback
      
  - name: Rollback atcron
    copy:
      src: '/etc/ansible/backup/atcron/at_deny_{{ansible_hostname}}'
      dest: /etc/at.deny
      remote_src: yes
    when: ((database.stdout_lines[1]|from_json).atcron_519_actual.atcron_519_actual | regex_search('(/etc/at.deny)')) != "/etc/at.deny"
    failed_when: no
    become: yes
    tags:
      - atcron
      - 5.1.9
      - five
      - rollback
      - all
      - rollback

  - name: Rollback atcron
    file:
      path: "/etc/at.allow"
      state: absent
    when: ((database.stdout_lines[1]|from_json).atcron_519_actual.atcron_519_actual | regex_search('(/etc/at.deny)')) != "/etc/at.deny"
    become: yes
    tags:
      - atcron
      - 5.1.9
      - five
      - rollback
      - all
      - rollback
    
  - name: Rollback sshdperm
    file:
      path: "/etc/ssh/sshd_config"
      mode: 0644
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).sshdperm_521_actual.sshdperm_521_actual | regex_search('(/etc/ssh/sshd_config)')) != "/etc/ssh/sshd_config"
    become: yes
    tags:
      - sshdperm
      - 5.2.1
      - five
      - all
      - rollback
  
  - name: Rollback sshpermpvtkey
    command: "{{item}}"
    with_items:
      - find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chown root:ssh_keys {} \;
      - find /etc/ssh -xdev -type f -name 'ssh_host_*_key' -exec chmod 0640 {} \;
    when: ((database.stdout_lines[1]|from_json).sshpermpvtkey_522_actual.sshpermpvtkey_522_actual | regex_search('(root)')) != "root"
    become: yes
    tags:
      - sshpermpvtkey
      - 5.2.2
      - five
      - all
      - rollback
      
  - name: Rollback sshpermpubkey
    command: "{{item}}"
    with_items:
      - find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chown root:root {} \;
      - find /etc/ssh -xdev -type f -name 'ssh_host_*_key.pub' -exec chmod 0600 {} \;
    when: ((database.stdout_lines[1]|from_json).sshpermpubkey_523_actual.sshpermpubkey_523_actual | regex_search('(root)')) != "root"
    become: yes
    tags:
      - sshpermpubkey
      - 5.2.3
      - five
      - all
      - rollback
       
  - name: Rollback sshaccess
    lineinfile:
      path: /etc/ssh/sshd_config
      state: absent
      regexp: '{{ item }}'
    with_items:
      - "^(AllowUsers.*)"
      - "^(AllowGroups.*)"
      - "^(DenyUsers.*)"
      - "^(DenyGroups.*)"
    when: ((database.stdout_lines[1]|from_json).sshaccess_524_actual.sshaccess_524_actual | regex_search('(AllowGroups)')) != "AllowGroups" and ((database.stdout_lines[1]|from_json).sshaccess_524_actual.sshaccess_524_actual | regex_search('(DenyUsers)')) != "DenyUsers" and ((database.stdout_lines[1]|from_json).sshaccess_524_actual.sshaccess_524_actual | regex_search('(AllowUsers)')) != "AllowUsers" and ((database.stdout_lines[1]|from_json).sshaccess_524_actual.sshaccess_524_actual | regex_search('(DenyGroups)')) != "DenyGroups"
    become: yes
    tags:
      - sshaccess
      - 5.2.4
      - five
      - all
      - rollback

  - name: Rollback sshloglevel
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(LogLevel INFO)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).sshloglevel_525_actual.sshloglevel_525_actual | regex_search('(INFO)')) != "INFO"
    become: yes
    tags:
      - sshloglevel
      - 5.2.5
      - five
      - all
      - rollback

  - name: Rollback sshx11forward
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(X11Forwarding*)"
      replace: "X11Forwarding yes"
    when: ((database.stdout_lines[1]|from_json).sshx11forward_526_actual.sshx11forward_526_actual | regex_search('(no)')) != "no"
    become: yes
    tags:
      - sshx11forward
      - 5.2.6
      - five
      - all
      - rollback

  - name: Rollback sshmaxauthtries
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(MaxAuthTries.*)"
      line: "#MaxAuthTries 6"
    when: ((database.stdout_lines[1]|from_json).sshmaxauthtries_527_actual.sshmaxauthtries_527_actual | regex_search('(maxauthtries)')) != "maxauthtries"
    become: yes
    tags:
      - sshmaxauthtries
      - 5.2.7
      - five
      - all
      - rollback

  - name: Rollback sshignorerhosts
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(IgnoreRhosts*)"
      line: "#IgnoreRhosts yes"
    when: ((database.stdout_lines[1]|from_json).sshignorerhosts_528_actual.sshignorerhosts_528_actual | regex_search('(IgnoreRhosts)')) != "IgnoreRhosts"
    become: yes
    tags:
      - sshignorerhosts
      - 5.2.8
      - five
      - all
      - rollback

  - name: Rollback sshauthentication
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(HostbasedAuthentication.*)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).sshauthentication_529_actual.sshauthentication_529_actual | regex_search('(HostbasedAuthentication)')) != "HostbasedAuthentication"
    become: yes
    tags:
      - sshauthentication
      - 5.2.9
      - five
      - all
      - rollback

  - name: Rollback sshrootlogin
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(PermitRootLogin.*)"
      replace: "PermitRootLogin yes"
    when: ((database.stdout_lines[1]|from_json).sshrootlogin_5210_actual.sshrootlogin_5210_actual | regex_search('(PermitRootLogin)')) != "PermitRootLogin"
    become: yes
    tags:
      - sshrootlogin
      - 5.2.10
      - five
      - all
      - rollback

  - name: Rollback sshpep
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(PermitEmptyPasswords.*)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).sshpep_5211_actual.sshpep_5211_actual | regex_search('(PermitEmptyPasswords)')) != "PermitEmptyPasswords"
    become: yes
    tags:
      - sshpep
      - 5.2.11
      - five
      - all
      - rollback

  - name: Rollback sshpue
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(PermitUserEnvironment*)"
      line: "#PermitUserEnvironment no"
    when: ((database.stdout_lines[1]|from_json).sshpue_5212_actual.sshpue_5212_actual | regex_search('(PermitUserEnvironment)')) != "PermitUserEnvironment"
    become: yes
    tags:
      - sshpue
      - 5.2.12
      - five
      - all
      - rollback

  - name: Rollback sshchipers
    lineinfile:
      path: /etc/ssh/sshd_config
      state: absent
      regexp: "^(Ciphers*|#Ciphers*)"
      line: "Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr"
    when: ((database.stdout_lines[1]|from_json).sshchipers_5213_actual.sshchipers_5213_actual | regex_search('(Ciphers)')) != "Ciphers"
    become: yes
    tags:
      - sshchipers
      - 5.2.13
      - five
      - all
      - rollback

  - name: Rollback sshmacalgorithm
    lineinfile:
      path: /etc/ssh/sshd_config
      line: "MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256"
      state: absent
    when: ((database.stdout_lines[1]|from_json).sshmacalgorithm_5214_actual.sshmacalgorithm_5214_actual | regex_search('(MACs)')) != "MACs"
    become: yes
    tags:
      - sshmacalgorithm
      - 5.2.14
      - five
      - all
      - rollback

  - name: Rollback sshkeyexalgorithm
    lineinfile:
      path: /etc/ssh/sshd_config
      line: "KexAlgorithms curve25519-sha256,curve25519-sha256@libssh.org,diffie-hellman-group16-sha512,diffie-hellman-group18-sha512,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256"
      state: absent
    when: ((database.stdout_lines[1]|from_json).sshkeyexalgorithm_5215_actual.sshkeyexalgorithm_5215_actual | regex_search('(KexAlgorithms)')) != "KexAlgorithms"
    become: yes
    tags:
      - sshkeyexalgorithm
      - 5.2.15
      - five
      - all
      - rollback

  - name: Rollback sshidletimeout
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(ClientAliveInterval.*)"
      line: "#ClientAliveInterval 0"
    when: ((database.stdout_lines[1]|from_json).sshidletimeout_5216_actual.sshidletimeout_5216_actual | regex_search('(clientalivecountmax)')) != "clientalivecountmax" and ((database.stdout_lines[1]|from_json).sshidletimeout_5216_actual.sshidletimeout_5216_actual | regex_search('(clientaliveinterval)')) != "clientaliveinterval"
    become: yes
    tags:
      - sshidletimeout
      - 5.2.16
      - five
      - all
      - rollback

  - name: Rollback sshidletimeout
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(ClientAliveCountMax.*)"
      line: "#ClientAliveCountMax 3"
    when: ((database.stdout_lines[1]|from_json).sshidletimeout_5216_actual.sshidletimeout_5216_actual | regex_search('(clientalivecountmax)')) != "clientalivecountmax" and ((database.stdout_lines[1]|from_json).sshidletimeout_5216_actual.sshidletimeout_5216_actual | regex_search('(clientaliveinterval)')) != "clientaliveinterval"
    become: yes
    tags:
      - sshidletimeout
      - 5.2.16
      - five
      - all
      - rollback

  - name: Rollback sshlogingracetime
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(LoginGraceTime.*)"
      line: "#LoginGraceTime 2m"
    when: ((database.stdout_lines[1]|from_json).sshlogingracetime_5217_actual.sshlogingracetime_5217_actual | regex_search('(logingracetime)')) != "logingracetime"
    become: yes
    tags:
      - sshlogingracetime
      - 5.2.17
      - five
      - all
      - rollback

  - name: Rollback sshwarningbanner
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(Banner /etc/issue.net)"
      line: "#Banner none"
    when: ((database.stdout_lines[1]|from_json).sshwarningbanner_5218_actual.sshwarningbanner_5218_actual | regex_search('(Banner)')) != "Banner"
    become: yes
    tags:
      - sshwarningbanner
      - 5.2.18
      - five
      - all
      - rollback

  - name: Rollback sshpam
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(UsePAM yes)"
      line: "UsePAM no"
    when: ((database.stdout_lines[1]|from_json).sshpam_5219_actual.sshpam_5219_actual | regex_search('(usepam)')) != "usepam"
    become: yes
    tags:
      - sshpam
      - 5.2.19
      - five
      - all
      - rollback

  - name: Rollback sshtcpforward
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(AllowTcpForwarding.*)"
      line: "#AllowTcpForwarding yes"
    when: ((database.stdout_lines[1]|from_json).sshtcpforward_5220_actual.sshtcpforward_5220_actual | regex_search('(AllowTcpForwarding)')) != "AllowTcpForwarding"
    become: yes
    tags:
      - sshtcpforward
      - 5.2.20
      - five
      - all
      - rollback

  - name: Rollback sshmaxstartups
    replace:
      path: /etc/ssh/sshd_config
      regexp: "^(MaxStartups.*)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).sshmaxstartups_5221_actual.sshmaxstartups_5221_actual | regex_search('(MaxStartups)')) != "MaxStartups"
    become: yes
    tags:
      - sshmaxstartups
      - 5.2.21
      - five
      - all
      - rollback

  - name: Rollback sshmaxsessions
    lineinfile:
      path: /etc/ssh/sshd_config
      state: present
      regexp: "^(MaxSessions.*)"
      line: "#MaxSessions 10"
    when: ((database.stdout_lines[1]|from_json).sshmaxsessions_5222_actual.sshmaxsessions_5222_actual | regex_search('(MaxSessions)')) != "MaxSessions"
    become: yes
    tags:
      - sshmaxsessions
      - 5.2.22
      - five
      - all    
      - rollback
    
  - name: Rollback passwdcreation
    replace:
      path: /etc/security/pwquality.conf
      regexp: "^(minlen = 14)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).passwdcreation_531_actual.passwdcreation_531_actual | regex_search('(minlen)')) != "minlen" and ((database.stdout_lines[1]|from_json).passwdcreation_531_actual.passwdcreation_531_actual | regex_search('(minclass)')) != "minclass"
    become: yes
    tags:
      - passwdcreation
      - 5.3.1
      - five
      - all
      - rollback

  - name: Rollback passwdcreation
    replace:
      path: /etc/security/pwquality.conf
      regexp: "^(minclass = 4)"
      replace: '#\1'
    when: ((database.stdout_lines[1]|from_json).passwdcreation_531_actual.passwdcreation_531_actual | regex_search('(minlen)')) != "minlen" and ((database.stdout_lines[1]|from_json).passwdcreation_531_actual.passwdcreation_531_actual | regex_search('(minclass)')) != "minclass"
    become: yes
    tags:
      - passwdcreation
      - 5.3.1
      - five
      - all  
      - rollback
      
  - name: Rollback lockout
    lineinfile:
      path: /etc/pam.d/password-auth
      state: absent
      line: "{{item}}"
    with_items:
      - "auth   required   pam_faillock.so preauth silent audit deny=5 unlock_time=900"
      - "auth [default=die] pam_faillock.so authfail audit deny=5 unlock_time=900"
      - "account   required   pam_faillock.so"
    when: ((database.stdout_lines[1]|from_json).lockout_532_actual.lockout_532_actual | regex_search('(auth)')) != "auth" and ((database.stdout_lines[1]|from_json).lockout_532_actual.lockout_532_actual | regex_search('(account)')) != "account"
    become: yes
    tags:
      - lockout
      - 5.3.2
      - five
      - all
      - rollback

  - name: Rollback lockout
    lineinfile:
      path: /etc/pam.d/system-auth
      state: absent
      line: "{{item}}"
    with_items:
      - "auth   required   pam_faillock.so preauth silent audit deny=5 unlock_time=900"
      - "auth [default=die] pam_faillock.so authfail audit deny=5 unlock_time=900"
      - "account   required   pam_faillock.so"
    when: ((database.stdout_lines[1]|from_json).lockout_532_actual.lockout_532_actual | regex_search('(auth)')) != "auth" and ((database.stdout_lines[1]|from_json).lockout_532_actual.lockout_532_actual | regex_search('(account)')) != "account"
    become: yes
    tags:
      - lockout
      - 5.3.2
      - five
      - all    
      - rollback
      
  - name: Rollback passwdhashing
    command: sed -i '/password.*sufficient.*pam_unix.so/s/sha512//g' /etc/pam.d/password-auth
    when: ((database.stdout_lines[1]|from_json).passwdhashing_533_actual.passwdhashing_533_actual | regex_search('(sha512)')) != "sha512"
    become: yes
    tags:
      - passwdhashing
      - 5.3.3
      - five
      - all
      - rollback

  - name: Rollback passwdhashing
    command: sed -i '/password.*sufficient.*pam_unix.so/s/sha512//g' /etc/pam.d/system-auth
    when: ((database.stdout_lines[1]|from_json).passwdhashing_533_actual.passwdhashing_533_actual | regex_search('(sha512)')) != "sha512"
    become: yes
    tags:
      - passwdhashing
      - 5.3.3
      - five
      - all
      - rollback

  - name: Rollback passwdreuse
    command: sed -i '/password.*sufficient.*pam_unix.so/s/remember=5//g' /etc/pam.d/system-auth
    when: ((database.stdout_lines[1]|from_json).passwdreuse_534_actual.passwdreuse_534_actual | regex_search('(remember=5)')) != "remember=5"
    become: yes
    tags:
      - passwdreuse
      - 5.3.4
      - five
      - all
      - rollback

  - name: Rollback passwdreuse
    command: sed -i '/password.*sufficient.*pam_unix.so/s/remember=5//g' /etc/pam.d/password-auth
    when: ((database.stdout_lines[1]|from_json).passwdreuse_534_actual.passwdreuse_534_actual | regex_search('(remember=5)')) != "remember=5"
    become: yes
    tags:
      - passwdreuse
      - 5.3.4
      - five
      - all    
      - rollback

  - name: Rollback passwdexpiration
    debug: msg={{ (database.stdout_lines[1]|from_json).passwdexpiration_5411_actual.passwdexpiration_5411_actual.split(',') | regex_replace('failed ', '') }}
    register: passreg
    when: ((database.stdout_lines[1]|from_json).passwdexpiration_5411_actual.passwdexpiration_5411_actual | regex_search('(password expiration)')) != "password expiration"
    become: yes
    tags:
      - passwdexpiration
      - 5.4.1.1
      - five
      - all
      - rollback

  - name: Rollback passwdexpiration
    lineinfile:
      path: /etc/login.defs
      state: present
      regexp: "^(PASS_MAX_DAYS.*)"
      line: "{{ passreg.msg[0] }}"
    when: ((database.stdout_lines[1]|from_json).passwdexpiration_5411_actual.passwdexpiration_5411_actual | regex_search('(password expiration)')) != "password expiration"
    become: yes
    tags:
      - passwdexpiration
      - 5.4.1.1
      - five
      - all
      - rollback

  - name: Rollback passwdexpiration
    chage: user="{{ item | regex_search('[a-zA-Z].*')}}" sp_max="{{ item | regex_search('^[0-9]*') }}"
    loop: "{{ passreg.msg }}"
    when:
      - ((database.stdout_lines[1]|from_json).passwdexpiration_5411_actual.passwdexpiration_5411_actual | regex_search('(password expiration)')) != "password expiration"
      - item != "{{ passreg.msg[0] }}"
    become: yes
    tags:
      - passwdexpiration
      - 5.4.1.1
      - five
      - all
      - rollback
      
  - name: Rollback minidays
    debug: msg={{ (database.stdout_lines[1]|from_json).minidays_5412_actual.minidays_5412_actual.split(',') | regex_replace('failed ', '') }}
    register: minireg
    when: ((database.stdout_lines[1]|from_json).minidays_5412_actual.minidays_5412_actual | regex_search('(minimum days)')) != "minimum days"
    become: yes
    tags:
      - minidays
      - 5.4.1.2
      - five
      - all
      - rollback

  - name: Rollback minidays
    lineinfile:
      path: /etc/login.defs
      state: present
      regexp: "^(PASS_MIN_DAYS.*)"
      line: "{{ minireg.msg[0] }}"
    when: ((database.stdout_lines[1]|from_json).minidays_5412_actual.minidays_5412_actual | regex_search('(minimum days)')) != "minimum days"
    become: yes
    tags:
      - minidays
      - 5.4.1.2
      - five
      - all
      - rollback

  - name: Rollback minidays
    chage: user="{{ item | regex_search('[a-zA-Z].*')}}" sp_min="{{ item | regex_search('^[0-9]*') }}"
    loop: "{{ minireg.msg }}"
    when:
      - ((database.stdout_lines[1]|from_json).minidays_5412_actual.minidays_5412_actual | regex_search('(minimum days)')) != "minimum days"
      - item != "{{ minireg.msg[0] }}"
    become: yes
    tags:
      - minidays
      - 5.4.1.2
      - five
      - all    
      - rollback
      
  - name: Rollback warningdays
    debug: msg={{ (database.stdout_lines[1]|from_json).warningdays_5413_actual.warningdays_5413_actual.split(',') | regex_replace('failed ', '') }}
    register: warnreg
    when: ((database.stdout_lines[1]|from_json).warningdays_5413_actual.warningdays_5413_actual | regex_search('(warning days)')) != "warning days"
    become: yes
    tags:
      - warningdays
      - 5.4.1.3
      - five
      - all
      - rollback

  - name: Rollback warningdays
    lineinfile:
      path: /etc/login.defs
      state: present
      regexp: "^(PASS_WARN_AGE.*)"
      line: "{{ warnreg.msg[0] }}"
    when: ((database.stdout_lines[1]|from_json).warningdays_5413_actual.warningdays_5413_actual | regex_search('(warning days)')) != "warning days"
    become: yes
    tags:
      - warningdays
      - 5.4.1.3
      - five
      - all
      - rollback

  - name: Rollback warningdays
    chage: user="{{ item | regex_search('[a-zA-Z].*')}}" sp_warn="{{ item | regex_search('^[0-9]*') }}"
    loop: "{{ warnreg.msg }}"
    when:
      - ((database.stdout_lines[1]|from_json).warningdays_5413_actual.warningdays_5413_actual | regex_search('(warning days)')) != "warning days"
      - item != "{{ warnreg.msg[0] }}"
    become: yes
    tags:
      - warningdays
      - 5.4.1.3
      - five
      - all    
      - rollback
      
  - name: Rollback inactivepasswdlock
    debug: msg={{ (database.stdout_lines[1]|from_json).inactivepasswdlock_5414_actual.inactivepasswdlock_5414_actual.split(',') | regex_replace('failed ', '') }}
    register: inactreg
    when: ((database.stdout_lines[1]|from_json).inactivepasswdlock_5414_actual.inactivepasswdlock_5414_actual | regex_search('(inactive password)')) != "inactive password"
    become: yes
    tags:
      - inactivepasswdlock
      - 5.4.1.4
      - five
      - all
      - rollback

  - name: Rollback inactivepasswdlock
    shell: "useradd -D -f {{ inactreg.msg[0] | regex_replace('INACTIVE ', '') }}"
    when: ((database.stdout_lines[1]|from_json).inactivepasswdlock_5414_actual.inactivepasswdlock_5414_actual | regex_search('(inactive password)')) != "inactive password"
    become: yes
    tags:
      - inactivepasswdlock
      - 5.4.1.4
      - five
      - all
      - rollback

  - name: Rollback inactivepasswdlock
    chage: user="{{ item | regex_search('[a-zA-Z].*')}}" sp_inact="{{ item | regex_search('^[0-9]*') }}"
    loop: "{{ inactreg.msg }}"
    when:
      - ((database.stdout_lines[1]|from_json).inactivepasswdlock_5414_actual.inactivepasswdlock_5414_actual | regex_search('(inactive password)')) != "inactive password"
      - item != "{{ inactreg.msg[0] }}"
    become: yes
    tags:
      - inactivepasswdlock
      - 5.4.1.4
      - five
      - all
      - rollback

  - name: Rollback lastpasswdchange
    command: "passwd -f -u {{item}}"
    loop: "{{ ((database.stdout_lines[1]|from_json).lastpasswdchange_5415_actual.lastpasswdchange_5415_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).lastpasswdchange_5415_actual.lastpasswdchange_5415_actual | regex_search('(in the past)')) != "in the past"
    become: yes
    tags:
      - lastpasswdchange
      - 5.4.1.5
      - five
      - all
      - rollback

  - name: Rollback sysaccnonlogin
    user:
      name: "{{ item |  regex_search('^[a-z]*') }}"
      shell: "{{ item |  regex_search('/.*') }}"
    loop: "{{ (database.stdout_lines[1]|from_json).sysaccnonlogin_542_actual.sysaccnonlogin_542_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).sysaccnonlogin_542_actual.sysaccnonlogin_542_actual | regex_search('(System accounts)')) != "System accounts"
    become: yes
    tags:
      - sysaccnonlogin
      - 5.4.2
      - five
      - all
      - rollback

  - name: Rollback defaultgroup
    shell: 'usermod -g {{ item }} root'
    loop: "{{ (database.stdout_lines[1]|from_json).defaultgroup_543_actual.defaultgroup_543_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).defaultgroup_543_actual.defaultgroup_543_actual | regex_search('(default group)')) != "default group"
    become: yes
    tags:
      - defaultgroup
      - 5.4.3
      - five
      - all
      - rollback

  - name: Rollback usershelltimeout
    lineinfile:
      path: /etc/profile
      state: absent
      line: '{{ item }}'
    with_items:
      - "TMOUT=900"
      - "readonly TMOUT"
      - "export TMOUT"
    when: ((database.stdout_lines[1]|from_json).usershelltimeout_544_actual.usershelltimeout_544_actual | regex_search('(is configured)')) != "is configured" 
    become: yes
    tags:
      - usershelltimeout
      - 5.4.4
      - five
      - all
      - rollback

  - name: Rollback defaultuser
    copy:
       src: "/etc/ansible/backup/defaultuser/profile_{{ansible_hostname}}"
       dest: /etc/profile
       remote_src: yes
    when: ((database.stdout_lines[1]|from_json).defaultuser_545_actual.defaultuser_545_actual | regex_search('(umask 027)')) != "umask 027"
    become: yes
    tags:
      - defaultuser
      - 5.4.5
      - five
      - all
      - rollback

  - name: Rollback defaultuser
    copy:
       src: "/etc/ansible/backup/defaultuser/bashrc_{{ansible_hostname}}"
       dest: /etc/bashrc
       remote_src: yes
    when: ((database.stdout_lines[1]|from_json).defaultuser_545_actual.defaultuser_545_actual | regex_search('(umask 027)')) != "umask 027"
    become: yes
    tags:
      - defaultuser
      - 5.4.5
      - five
      - all
      - rollback

  - name: Rollback rootlogin
    debug: msg={{ (database.stdout_lines[1]|from_json).rootlogin_55_actual.rootlogin_55_actual.split(',') | regex_replace('failed ', '') }}
    register: rootloreg
    when: ((database.stdout_lines[1]|from_json).rootlogin_55_actual.rootlogin_55_actual | regex_search('(root login)')) != "root login"
    become: yes
    tags:
      - '5.5'
      - rootlogin
      - five
      - all
      - rollback

  - name: Rollback rootlogin
    lineinfile:
      path: /etc/securetty
      state: present
      line: "{{item}}"
    loop: "{{ rootloreg.msg }}"
    when: ((database.stdout_lines[1]|from_json).rootlogin_55_actual.rootlogin_55_actual | regex_search('(root login)')) != "root login"
    become: yes
    tags:
      - '5.5'
      - rootlogin
      - five
      - all
      - rollback

  - name: Rollback success
    command: sed -i '/^auth.*required.*pam_wheel.so.*/s/group=sugroup//g' /etc/pam.d/su
    when: ((database.stdout_lines[1]|from_json).suaccess_56_actual.suaccess_56_actual | regex_search('(group)')) != "group"
    become: yes
    tags:
      - suaccess
      - '5.6'
      - five
      - all
      - rollback

  - name: Rollback permpasswd
    file:
      path: "/etc/passwd"
      mode: 0640
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permpasswd_612_actual.permpasswd_612_actual | regex_search('(/etc/passwd)')) != "/etc/passwd"
    become: yes
    tags:
      - permpasswd
      - 6.1.2
      - six
      - all
      - rollback

  - name: Rollback permshadow
    file:
      path: "/etc/shadow"
      mode: 0600
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permshadow_613_actual.permshadow_613_actual | regex_search('(/etc/shadow)')) != "/etc/shadow"
    become: yes
    tags:
      - permshadow
      - 6.1.3
      - six
      - all
      - rollback

  - name: Rollback permgroup
    file:
      path: "/etc/group"
      mode: 0640
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permgroup_614_actual.permgroup_614_actual | regex_search('(/etc/group)')) != "/etc/group"
    become: yes
    tags:
      - permgroup
      - 6.1.4
      - six
      - all
      - rollback

  - name: Rollback permgshadow
    file:
      path: "/etc/gshadow"
      mode: 0600
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permgshadow_615_actual.permgshadow_615_actual | regex_search('(/etc/gshadow)')) != "/etc/gshadow"
    become: yes
    tags:
      - permgshadow
      - 6.1.5
      - six
      - all
      - rollback

  - name: Rollback permpasswdi
    file:
      path: "/etc/passwd-"
      mode: 0640
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permpasswdi_616_actual.permpasswdi_616_actual | regex_search('(/etc/passwd-)')) != "/etc/passwd-"
    become: yes
    tags:
      - permpasswdi
      - 6.1.6
      - six
      - all
      - rollback

  - name: Rollback permshadowi
    file:
      path: "/etc/shadow-"
      mode: 0600
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permshadowi_617_actual.permshadowi_617_actual | regex_search('(/etc/shadow-)')) != "/etc/shadow-"
    become: yes
    tags:
      - permshadowi
      - 6.1.7
      - six
      - all
      - rollback

  - name: Rollback permgroupi
    file:
      path: "/etc/group-"
      mode: 0640
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permgroupi_618_actual.permgroupi_618_actual | regex_search('(/etc/group-)')) != "/etc/group-"
    become: yes
    tags:
      - permgroupi
      - 6.1.8
      - six
      - all
      - rollback

  - name: Rollback permgshadowi
    file:
      path: "/etc/gshadow-"
      mode: 0600
      owner: root
      group: root
    when: ((database.stdout_lines[1]|from_json).permgshadowi_619_actual.permgshadowi_619_actual | regex_search('(/etc/gshadow-)')) != "/etc/gshadow-"
    become: yes
    tags:
      - permgshadowi
      - 6.1.9
      - six
      - all
      - rollback

  - name: Rollback wwfiles
    file:
      path: "{{ item |  regex_search('/.*') }}"
      mode: "{{ item |  regex_search('[0-9]+') }}"
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).wwfiles_6110_actual.wwfiles_6110_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).wwfiles_6110_actual.wwfiles_6110_actual | regex_search('(no world writable)')) != "no world writable"
    become: yes
    tags:
      - wwfiles
      - 6.1.10
      - six
      - all
      - rollback
   
  - name: Rollback unownedfiles
    user:
      name: unowneduser
      state: present
    when: ((database.stdout_lines[1]|from_json).unownedfiles_6111_actual.unownedfiles_6111_actual | regex_search('(no unowned files)')) != "no unowned files"
    become: yes
    tags:
      - unownedfiles
      - 6.1.11
      - six
      - all
      - rollback
      
  - name: Rollback unownedfiles
    shell: chown -R unowneduser /{{ item }}
    loop: "{{ ((database.stdout_lines[1]|from_json).unownedfiles_6111_actual.unownedfiles_6111_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).unownedfiles_6111_actual.unownedfiles_6111_actual | regex_search('(no unowned files)')) != "no unowned files"
    become: yes
    tags:
      - unownedfiles
      - 6.1.11
      - six
      - all
      - rollback
    
  - name: Rollback unownedfiles
    user:
      name: unowneduser
      state: absent
    when: ((database.stdout_lines[1]|from_json).unownedfiles_6111_actual.unownedfiles_6111_actual | regex_search('(no unowned files)')) != "no unowned files"
    become: yes
    tags:
      - unownedfiles
      - 6.1.11
      - six
      - all
      - rollback
      
  - name: Rollback unownedfiles
    file:
      path: '{{ item }}'
      state: absent
    with_items:
      - /var/spool/mail/unowneduser
      - /home/unowneduser
    when: ((database.stdout_lines[1]|from_json).unownedfiles_6111_actual.unownedfiles_6111_actual | regex_search('(no unowned files)')) != "no unowned files"
    become: yes
    tags:
      - unownedfiles
      - 6.1.11
      - six
      - all
      - rollback
      
  - name: grpadd
    group:
      name: ungroup
      state: present
    when: ((database.stdout_lines[1]|from_json).ungroupedfiles_6112_actual.ungroupedfiles_6112_actual | regex_search('(no ungrouped files)')) != "no ungrouped files"
    become: yes
    tags:
      - ungroupedfiles
      - 6.1.12
      - six
      - all
      - rollback
    
  - name: backup
    shell: chgrp -R ungroup /{{ item }}
    loop: "{{ ((database.stdout_lines[1]|from_json).ungroupedfiles_6112_actual.ungroupedfiles_6112_actual.stdout.split(',') | regex_replace('failed ', '')) }}"    
    when: ((database.stdout_lines[1]|from_json).ungroupedfiles_6112_actual.ungroupedfiles_6112_actual | regex_search('(no ungrouped files)')) != "no ungrouped files"
    become: yes
    tags:
      - ungroupedfiles
      - 6.1.12
      - six
      - all
      - rollback

  - name: grpremove
    group:
      name: ungroup
      state: absent
    when: ((database.stdout_lines[1]|from_json).ungroupedfiles_6112_actual.ungroupedfiles_6112_actual | regex_search('(no ungrouped files)')) != "no ungrouped files"
    become: yes
    tags:
      - ungroupedfiles
      - 6.1.12
      - six
      - all
      - rollback
      
  - name: Rollback shadowedpasswd
    command: sed -i "s/^{{item}}:x:*/{{item}}::/g" /etc/passwd
    loop: "{{ ((database.stdout_lines[1]|from_json).shadowedpass_621_actual.shadowedpass_621_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).shadowedpass_621_actual.shadowedpass_621_actual | regex_search('(shadowed passwords)')) != "shadowed passwords"
    become: yes
    tags:
      - shadowedpass
      - 6.2.1
      - six
      - all
      - rollback
      
  - name: Rollback emptypasswd
    command: "passwd -f -u {{item}}"
    loop: "{{ ((database.stdout_lines[1]|from_json).emptypasswd_622_actual.emptypasswd_622_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).emptypasswd_622_actual.emptypasswd_622_actual | regex_search('(Password fields)')) != "Password fields"
    become: yes
    tags:
      - emptypasswd
      - 6.2.2
      - six
      - all
      - rollback
  
  - name: Rollback rootuid
    shell: |
      a=$(grep '{{item}}' /etc/passwd | awk -F: '{print $3}')
      sed -i '/{{item}}/s/\x:'$a'\:/x:0:/g' /etc/passwd
    loop: "{{ ((database.stdout_lines[1]|from_json).rootuid_623_actual.rootuid_623_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).rootuid_623_actual.rootuid_623_actual | regex_search('(Root is the only UID)')) != "Root is the only UID"
    become: yes
    tags:
      - rootuid
      - 6.2.3
      - six
      - all
      - rollback
  
  - name: Rollback usershdir
    file:
      path: "/home/{{ item }}"
      state: absent
    failed_when: no
    loop: "{{ ((database.stdout_lines[1]|from_json).userhdir_625_actual.userhdir_625_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).userhdir_625_actual.userhdir_625_actual | regex_search('(users home)')) != "users home"
    become: yes
    tags:
      - usershdir
      - 6.2.5
      - six
      - all
      - rollback
      
  - name: Rollback userhdirperm
    file:
      path: "{{ item | regex_search('/.*') }}"
      state: directory
      mode: "{{ item | regex_search('[0-9]+') }}"
    loop: "{{ (database.stdout_lines[1]|from_json).userhdirperm_626_actual.userhdirperm_626_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).userhdirperm_626_actual.userhdirperm_626_actual | regex_search('(home directories)')) != "home directories"
    become: yes
    tags:
      - userhdirperm
      - 6.2.6
      - six
      - all
      - rollback

  - name: Rollback userownhdir
    file:
      path: "{{ item.split(' ')[0] }}"
      owner: "{{ item.split(' ')[1] }}"
      group: "{{ item.split(' ')[1] }}"
    loop: "{{ (database.stdout_lines[1]|from_json).userownhdir_627_actual.userownhdir_627_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).userownhdir_627_actual.userownhdir_627_actual | regex_search('users own')) != "users own"
    become: yes
    tags:
      - userownhdir
      - 6.2.7
      - six
      - all
      - rollback
      
  - name: Rollback dotfiles
    file:
      path: "{{ item |  regex_search('/.*') }}"
      mode: "{{ item |  regex_search('[0-9]+') }}"
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).dotfiles_628_actual.dotfiles_628_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).dotfiles_628_actual.dotfiles_628_actual | regex_search('(dot files)')) != "dot files"
    become: yes
    tags:
      - dotfiles
      - 6.2.8
      - six
      - all
      - rollback

  - name: Rollback forwardfiles
    copy:
      src: /etc/ansible/backup/forwardfiles{{item}}
      dest: '{{item}}'
      remote_src: yes
    loop: "{{ ((database.stdout_lines[1]|from_json).forwardfiles_629_actual.forwardfiles_629_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).forwardfiles_629_actual.forwardfiles_629_actual | regex_search('(Users have)')) != "Users have"      
    become: yes
    tags:
      - forwardfiles
      - 6.2.9
      - six
      - all
      - rollback
  
  - name: Rollback netrcfiles
    copy:
      src: /etc/ansible/backup/netrcfiles{{item}}
      dest: '{{item}}'
      remote_src: yes
    loop: "{{ ((database.stdout_lines[1]|from_json).netrcfiles_6210_actual.netrcfiles_6210_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).netrcfiles_6210_actual.netrcfiles_6210_actual | regex_search('(no users have)')) != "no users have"      
    become: yes
    tags:
      - netrcfiles
      - 6.2.10
      - six
      - all
      - rollback
      
  - name: Rollback grpnetrcfiles
    debug: msg={{ (database.stdout_lines[1]|from_json).grpnetrcfiles_6211_actual.grpnetrcfiles_6211_actual.split(',') | regex_replace('failed ', '') }}
    register: grpnetrcreg
    when: ((database.stdout_lines[1]|from_json).grpnetrcfiles_6211_actual.grpnetrcfiles_6211_actual | regex_search('(Users .netrc files)')) != "Users .netrc files"
    become: yes
    tags:
      - grpnetrcfiles
      - 6.2.11
      - six
      - all
      - rollback

  - name: Rollback grpnetrcfiles
    file:
      path: "{{ item |  regex_search('/.*') }}"
      mode: "{{ item |  regex_search('[0-9]+') }}"
    failed_when: no
    loop: "{{ grpnetrcreg.msg }}"
    when: ((database.stdout_lines[1]|from_json).grpnetrcfiles_6211_actual.grpnetrcfiles_6211_actual | regex_search('(Users .netrc files)')) != "Users .netrc files"
    become: yes
    tags:
      - grpnetrcfiles
      - 6.2.11
      - six
      - all
      - rollback

  - name: Rollback rhosts
    copy:
      src: /etc/ansible/backup/rhosts{{item}}
      dest: '{{item}}'
      remote_src: yes
    loop: "{{ ((database.stdout_lines[1]|from_json).rhosts_6212_actual.rhosts_6212_actual.split(',') | regex_replace('failed ', '')) }}"
    when: ((database.stdout_lines[1]|from_json).netrcfiles_6210_actual.netrcfiles_6210_actual | regex_search('(no users have)')) != "no users have"      
    become: yes
    tags:
      - rhosts
      - 6.2.12
      - six
      - all
      - rollback
      
  - name: Rollback groups
    lineinfile:
      path: /etc/group
      regexp: "^({{ item | regex_search('[a-z]*') }})"
      state: absent
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).groups_6213_actual.groups_6213_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).groups_6213_actual.groups_6213_actual | regex_search('(exist in)')) != "exist in"
    become: yes
    tags:
      - groups
      - 6.2.13
      - six
      - all
      - rollback
      
  - name: Rollback duplicateuid
    user:
      name: "{{ item | regex_search('[a-z]*') }}"
      uid: "{{ item | regex_search('[0-9]+') }}"
      non_unique: yes
    failed_when: no      
    loop: "{{ (database.stdout_lines[1]|from_json).duplicateuid_6214_actual.duplicateuid_6214_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).duplicateuid_6214_actual.duplicateuid_6214_actual | regex_search('(no duplicate UIDs)')) != "no duplicate UIDs"
    become: yes
    tags:
      - duplicateuid
      - 6.2.14
      - six
      - all
      - rollback
      
  - name: Rollback duplicategid
    group:
      name: "{{ item | regex_search('[a-z]*') }}"
      gid: "{{ item | regex_search('[0-9]+') }}"
      non_unique: yes
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).duplicategid_6215_actual.duplicategid_6215_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).duplicategid_6215_actual.duplicategid_6215_actual | regex_search('(no duplicate GIDs)')) != "no duplicate GIDs"
    become: yes
    tags:
      - duplicategid
      - 6.2.15
      - six
      - all
      - rollback
      
  - name: Rollback shadowgroup
    user:
       name: "{{item}}"
       group: shadow
    failed_when: no
    loop: "{{ (database.stdout_lines[1]|from_json).shadowgroup_6218_actual.shadowgroup_6218_actual.split(',') | regex_replace('failed ', '') }}"
    when: ((database.stdout_lines[1]|from_json).shadowgroup_6218_actual.shadowgroup_6218_actual | regex_search('(is empty)')) != "is empty"
    become: yes
    tags:
      - shadowgroup
      - 6.2.18
      - six
      - all
      - rollback

  - name: Rollback shadowgroup
    lineinfile:
      path: /etc/group
      state: present
      regexp: '^(shadow:x:.*)$'
      line: \1{{ (database.stdout_lines[1]|from_json).shadowgroup_6218_actual.shadowgroup_6218_actual | regex_replace('failed ', '') }}
      backrefs: yes
    failed_when: no
    when: ((database.stdout_lines[1]|from_json).shadowgroup_6218_actual.shadowgroup_6218_actual | regex_search('(is empty)')) != "is empty"
    become: yes
    tags:
      - shadowgroup
      - 6.2.18
      - six
      - all
      - rollback

  - name: Include Database
    include: tasks/after_linux.yml
